@model MealPrep.DAL.Entities.Meal
@using System.Text.Json
@using System.Security.Claims

@{
    ViewData["Title"] = Model.Name;
    
    // Parse ingredients and images from JSON
    var ingredients = new List<string>();
    var images = new List<string>();
    
    if (!string.IsNullOrEmpty(Model.Ingredients))
    {
        try
        {
            ingredients = JsonSerializer.Deserialize<List<string>>(Model.Ingredients) ?? new List<string>();
        }
        catch
        {
            // Fallback: treat as comma-separated string
            ingredients = Model.Ingredients.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries).ToList();
        }
    }
    
    if (!string.IsNullOrEmpty(Model.Images))
    {
        try
        {
            images = JsonSerializer.Deserialize<List<string>>(Model.Images) ?? new List<string>();
        }
        catch
        {
            // Fallback: treat as comma-separated string
            images = Model.Images.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries).ToList();
        }
    }
}

<div class="container py-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Trang Chủ</a></li>
            <li class="breadcrumb-item"><a asp-action="Index">Món Ăn</a></li>
            <li class="breadcrumb-item active">@Model.Name</li>
        </ol>
    </nav>

    <div class="row g-4">
        <!-- Left Column - Image & Description -->
        <div class="col-lg-7">
            <!-- Meal Image Card -->
            <div class="card app-card mb-4">
                @if (images.Any())
                {
                    <div id="mealImageCarousel" class="carousel slide" data-bs-ride="carousel">
                        <div class="carousel-inner">
                            @for (int i = 0; i < images.Count; i++)
                            {
                                <div class="carousel-item @(i == 0 ? "active" : "")">
                                    <img src="@images[i]" class="d-block w-100 meal-detail-image" 
                                         alt="@Model.Name" 
                                         style="object-fit: cover; height: 400px; border-radius: 0.5rem 0.5rem 0 0;" 
                                         onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'800\' height=\'400\'%3E%3Crect fill=\'%23667eea\' width=\'800\' height=\'400\'/%3E%3Ctext fill=\'white\' font-family=\'Arial\' font-size=\'24\' x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dominant-baseline=\'middle\'%3E@Model.Name%3C/text%3E%3C/svg%3E';">
                                </div>
                            }
                        </div>
                        @if (images.Count > 1)
                        {
                            <button class="carousel-control-prev" type="button" data-bs-target="#mealImageCarousel" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Previous</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#mealImageCarousel" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Next</span>
                            </button>
                            <div class="carousel-indicators">
                                @for (int i = 0; i < images.Count; i++)
                                {
                                    <button type="button" data-bs-target="#mealImageCarousel" data-bs-slide-to="@i" 
                                            class="@(i == 0 ? "active" : "")" aria-current="@(i == 0 ? "true" : "false")" aria-label="Slide @(i + 1)"></button>
                                }
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="meal-detail-image">
                        <div class="placeholder-content">
                            <i class="bi bi-image"></i>
                            <span>Hình Ảnh Món Ăn</span>
                        </div>
                    </div>
                }
            </div>

            <!-- Description Card -->
            <div class="card app-card">
                <div class="card-body">
                    <h5 class="card-title mb-3">
                        <i class="bi bi-info-circle text-primary"></i> Mô Tả
                    </h5>
                    @if(!string.IsNullOrEmpty(Model.Description))
                    {
                        <p class="text-muted mb-0">@Model.Description</p>
                    }
                    else
                    {
                        <p class="text-muted mb-0 fst-italic">
                            Một món ăn ngon và bổ dưỡng, chuẩn bị từ nguyên liệu tươi ngon. 
                            Hoàn hảo cho lối sống healthy của bạn.
                        </p>
                    }
                </div>
            </div>

            <!-- Ingredients Card -->
            <div class="card app-card mt-4">
                <div class="card-body">
                    <h5 class="card-title mb-3">
                        <i class="bi bi-list-check text-success"></i> Nguyên Liệu
                    </h5>
                    @if (ingredients.Any())
                    {
                        <ul class="list-unstyled mb-0">
                            @foreach(var ingredient in ingredients)
                            {
                                <li class="mb-2">
                                    <i class="bi bi-check2 text-success"></i> @ingredient
                                </li>
                            }
                        </ul>
                    }
                    else
                    {
                        <p class="text-muted mb-0 fst-italic">
                            Rau củ tươi, protein nạc, ngũ cốc nguyên hạt, và chất béo lành mạnh
                        </p>
                    }
                </div>
            </div>
        </div>

        <!-- Right Column - Details & Actions -->
        <div class="col-lg-5">
            <!-- Title & Price Card -->
            <div class="card app-card mb-4">
                <div class="card-body">
                    <h1 class="h3 mb-3">@Model.Name</h1>

                    @if(Model.IsActive)
                    {
                        <span class="badge bg-success-subtle text-success">
                            <i class="bi bi-check-circle"></i> Còn Hàng
                        </span>
                    }
                    else
                    {
                        <span class="badge bg-danger-subtle text-danger">
                            <i class="bi bi-x-circle"></i> Hết Hàng
                        </span>
                    }
                </div>
            </div>

            <!-- Nutrition Facts Card -->
            <div class="card app-card mb-4">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">
                        <i class="bi bi-heart-pulse text-danger"></i> Thông Tin Dinh Dưỡng
                    </h5>
                </div>
                <div class="card-body">
                    <div class="nutrition-item">
                        <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
                            <div>
                                <strong>Calo</strong>
                                <div class="text-muted small">Năng lượng</div>
                            </div>
                            <div class="text-end">
                                <div class="h4 mb-0 text-danger">@Model.Calories</div>
                                <div class="small text-muted">kcal</div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span><i class="bi bi-egg text-primary"></i> Đạm</span>
                                <strong>@Model.Protein g</strong>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-primary" style="width: @(Model.Protein * 2)%"></div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span><i class="bi bi-grain text-warning"></i> Carbohydrate</span>
                                <strong>@Model.Carbs g</strong>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-warning" style="width: @(Model.Carbs)%"></div>
                            </div>
                        </div>

                        <div class="mb-0">
                            <div class="d-flex justify-content-between mb-2">
                                <span><i class="bi bi-droplet text-info"></i> Chất Béo</span>
                                <strong>@Model.Fat g</strong>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-info" style="width: @(Model.Fat * 3)%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-grid gap-2">
                <a asp-controller="Subscription" asp-action="Index" class="btn btn-primary btn-lg">
                    <i class="bi bi-calendar-check"></i> Đăng Ký Để Nhận Món Này
                </a>
                @if (User.Identity?.IsAuthenticated == true)
                {
                    <form method="post" asp-controller="Auth" asp-action="ToggleDislikedMeal" class="d-inline">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="mealId" value="@Model.Id" />
                        <button type="submit" class="btn btn-outline-warning w-100">
                            <i class="bi bi-hand-thumbs-down"></i> 
                            @(ViewBag.IsDisliked == true ? "Bỏ Không Thích" : "Không Thích Món Này")
                        </button>
                    </form>
                }
                <a asp-action="Index" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Quay Lại Danh Sách
                </a>
            </div>

            <!-- Info Alert -->
            <div class="alert alert-info mt-4" role="alert">
                <i class="bi bi-info-circle"></i>
                <strong>Đăng ký để đặt món:</strong> Thêm món này vào gói đăng ký hàng tuần để thưởng thức ăn uống healthy.
            </div>
        </div>
    </div>
</div>

<style>
    .meal-detail-image {
        height: 400px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
        border-radius: 0.5rem;
    }

    .meal-detail-image::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: repeating-linear-gradient(
            45deg,
            rgba(255, 255, 255, 0.05),
            rgba(255, 255, 255, 0.05) 15px,
            transparent 15px,
            transparent 30px
        );
    }

    .placeholder-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        color: white;
        font-size: 3rem;
        z-index: 1;
    }

    .placeholder-content span {
        font-size: 1rem;
        margin-top: 1rem;
        font-weight: 500;
    }

    .progress {
        background-color: #e9ecef;
        border-radius: 0.25rem;
        overflow: hidden;
    }

    .nutrition-item strong {
        font-weight: 600;
    }
</style>