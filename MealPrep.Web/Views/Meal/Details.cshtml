@model BusinessObjects.Entities.Meal
@using System.Text.Json
@using System.Security.Claims

@{
    ViewData["Title"] = Model.Name;
    
    var ingredients = new List<string>();
    var images = new List<string>();
    
    if (!string.IsNullOrEmpty(Model.Ingredients))
    {
        try
        {
            ingredients = JsonSerializer.Deserialize<List<string>>(Model.Ingredients) ?? new List<string>();
        }
        catch
        {
            ingredients = Model.Ingredients.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries).ToList();
        }
    }
    
    if (!string.IsNullOrEmpty(Model.Images))
    {
        try
        {
            images = JsonSerializer.Deserialize<List<string>>(Model.Images) ?? new List<string>();
        }
        catch
        {
            images = Model.Images.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries).ToList();
        }
    }
}

<div class="meal-details-page">
    <div class="container py-5">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Trang Ch?</a></li>
                <li class="breadcrumb-item"><a asp-action="Index">Món An</a></li>
                <li class="breadcrumb-item active">@Model.Name</li>
            </ol>
        </nav>

        <div class="row g-4">
            <!-- Left Column - Image & Description -->
            <div class="col-lg-7">
                <!-- Meal Image -->
                <div class="meal-image-card mb-4">
                    <div class="card border-0 shadow-sm">
                        @if (images.Any())
                        {
                            <div id="mealImageCarousel" class="carousel slide" data-bs-ride="carousel">
                                <div class="carousel-inner">
                                    @for (int i = 0; i < images.Count; i++)
                                    {
                                        <div class="carousel-item @(i == 0 ? "active" : "")">
                                            <img src="@images[i]" class="d-block w-100 meal-detail-image" 
                                                 alt="@Model.Name" 
                                                 onerror="if(this.src.indexOf('data:image') === -1) { this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'800\' height=\'400\'%3E%3Crect fill=\'%23e5e7eb\' width=\'800\' height=\'400\'/%3E%3Ctext fill=\'%239ca3af\' font-family=\'Arial\' font-size=\'24\' x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dominant-baseline=\'middle\'%3ENo Image%3C/text%3E%3C/svg%3E'; }">
                                        </div>
                                    }
                                </div>
                                @if (images.Count > 1)
                                {
                                    <button class="carousel-control-prev" type="button" data-bs-target="#mealImageCarousel" data-bs-slide="prev">
                                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                    </button>
                                    <button class="carousel-control-next" type="button" data-bs-target="#mealImageCarousel" data-bs-slide="next">
                                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                    </button>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="meal-detail-image-placeholder">
                                <i class="bi bi-image"></i>
                                <span>Hình ?nh Món An</span>
                            </div>
                        }
                    </div>
                </div>

                <!-- Description -->
                <div class="content-card mb-4">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header-custom">
                            <h5 class="card-title-custom mb-0">Mô T?</h5>
                        </div>
                        <div class="card-body-custom">
                            @if(!string.IsNullOrEmpty(Model.Description))
                            {
                                <p class="text-muted mb-0">@Model.Description</p>
                            }
                            else
                            {
                                <p class="text-muted mb-0 fst-italic">
                                    M?t món an ngon và b? du?ng, chu?n b? t? nguyên li?u tuoi ngon.
                                </p>
                            }
                        </div>
                    </div>
                </div>

                <!-- Ingredients -->
                <div class="content-card">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header-custom">
                            <h5 class="card-title-custom mb-0">Nguyên Li?u</h5>
                        </div>
                        <div class="card-body-custom">
                            @if (ingredients.Any())
                            {
                                <ul class="ingredients-list">
                                    @foreach(var ingredient in ingredients)
                                    {
                                        <li>@ingredient</li>
                                    }
                                </ul>
                            }
                            else
                            {
                                <p class="text-muted mb-0 fst-italic">
                                    Rau c? tuoi, protein n?c, ngu c?c nguyên h?t, và ch?t béo lành m?nh
                                </p>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Details & Actions -->
            <div class="col-lg-5">
                <!-- Title Card -->
                <div class="content-card mb-4">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body-custom">
                            <h1 class="meal-title mb-3">@Model.Name</h1>
                            @if(Model.IsActive)
                            {
                                <span class="badge bg-success">
                                    <i class="bi bi-check-circle me-1"></i>Còn Hàng
                                </span>
                            }
                            else
                            {
                                <span class="badge bg-danger">
                                    <i class="bi bi-x-circle me-1"></i>H?t Hàng
                                </span>
                            }
                        </div>
                    </div>
                </div>

                <!-- Nutrition Facts -->
                <div class="content-card mb-4">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header-custom">
                            <h5 class="card-title-custom mb-0">Thông Tin Dinh Du?ng</h5>
                        </div>
                        <div class="card-body-custom">
                            <div class="nutrition-item mb-3 pb-3 border-bottom">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>Calo</strong>
                                        <div class="text-muted small">Nang lu?ng</div>
                                    </div>
                                    <div class="text-end">
                                        <div class="h4 mb-0 text-danger">@Model.Calories</div>
                                        <div class="small text-muted">kcal</div>
                                    </div>
                                </div>
                            </div>

                            <div class="nutrition-macro mb-3">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Ð?m</span>
                                    <strong>@Model.Protein g</strong>
                                </div>
                                <div class="progress" style="height: 6px;">
                                    <div class="progress-bar bg-primary" style="width: @(Math.Min(Model.Protein * 2, 100))%"></div>
                                </div>
                            </div>

                            <div class="nutrition-macro mb-3">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Carbohydrate</span>
                                    <strong>@Model.Carbs g</strong>
                                </div>
                                <div class="progress" style="height: 6px;">
                                    <div class="progress-bar bg-warning" style="width: @(Math.Min(Model.Carbs, 100))%"></div>
                                </div>
                            </div>

                            <div class="nutrition-macro">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Ch?t Béo</span>
                                    <strong>@Model.Fat g</strong>
                                </div>
                                <div class="progress" style="height: 6px;">
                                    <div class="progress-bar bg-info" style="width: @(Math.Min(Model.Fat * 3, 100))%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="action-buttons">
                    <a asp-controller="Subscription" asp-action="Index" class="btn btn-primary btn-lg w-100 mb-2">
                        <i class="bi bi-calendar-check me-2"></i>Ðang Ký Ð? Nh?n Món Này
                    </a>
                    @if (User.Identity?.IsAuthenticated == true)
                    {
                        <form method="post" asp-controller="Auth" asp-action="ToggleDislikedMeal" class="d-inline w-100">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="mealId" value="@Model.Id" />
                            <button type="submit" class="btn btn-outline-secondary w-100 mb-2">
                                <i class="bi bi-hand-thumbs-down me-2"></i>
                                @(ViewBag.IsDisliked == true ? "B? Không Thích" : "Không Thích Món Này")
                            </button>
                        </form>
                    }
                    <a asp-action="Index" class="btn btn-outline-secondary w-100">
                        <i class="bi bi-arrow-left me-2"></i>Quay L?i Danh Sách
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .meal-details-page {
        background: #f8f9fa;
        min-height: 100vh;
    }

    .breadcrumb {
        background: transparent;
        padding: 0;
    }

    .breadcrumb-item a {
        color: #6b7280;
        text-decoration: none;
    }

    .breadcrumb-item.active {
        color: #1f2937;
    }

    .meal-detail-image {
        height: 400px;
        object-fit: cover;
        border-radius: 0.75rem 0.75rem 0 0;
    }

    .meal-detail-image-placeholder {
        height: 400px;
        background: #e5e7eb;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #9ca3af;
        font-size: 1.5rem;
    }

    .meal-detail-image-placeholder span {
        font-size: 0.875rem;
        margin-top: 0.5rem;
    }

    .content-card .card {
        border-radius: 0.75rem;
    }

    .card-header-custom {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid #e5e7eb;
        background: #f9fafb;
    }

    .card-title-custom {
        font-size: 1rem;
        font-weight: 600;
        color: #1f2937;
        margin: 0;
    }

    .card-body-custom {
        padding: 1.25rem;
    }

    .meal-title {
        font-size: 1.75rem;
        font-weight: 600;
        color: #1f2937;
        margin: 0;
    }

    .ingredients-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .ingredients-list li {
        padding: 0.5rem 0;
        color: #374151;
        border-bottom: 1px solid #f3f4f6;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .ingredients-list li:last-child {
        border-bottom: none;
    }

    .ingredients-list li::before {
        content: "•";
        color: #16a34a;
        font-weight: bold;
        font-size: 1.25rem;
    }

    .nutrition-item {
        border-bottom: 1px solid #e5e7eb;
    }

    .nutrition-macro {
        margin-bottom: 1rem;
    }

    .progress {
        background-color: #f3f4f6;
        border-radius: 0.25rem;
    }

    .btn-primary {
        background: #1f2937;
        border-color: #1f2937;
        font-weight: 500;
    }

    .btn-primary:hover {
        background: #111827;
        border-color: #111827;
    }

    .btn-outline-secondary {
        border-color: #d1d5db;
        color: #374151;
        font-weight: 500;
    }

    .btn-outline-secondary:hover {
        background: #f3f4f6;
        border-color: #9ca3af;
        color: #1f2937;
    }

    .badge {
        font-weight: 500;
        padding: 0.375rem 0.75rem;
    }
</style>
