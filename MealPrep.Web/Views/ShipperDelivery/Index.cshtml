@model List<MealPrep.DAL.Entities.DeliveryOrder>
@using MealPrep.DAL.Enums
@{
    ViewData["Title"] = "Danh Sách Đơn Hàng";
    Layout = "_Layout";
}

<div class="container py-5">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="fw-bold mb-1">Danh Sách Đơn Hàng</h1>
            <p class="text-muted mb-0">
                <i class="bi bi-calendar3 me-1"></i>
                Ngày giao: @ViewBag.DeliveryDate.ToString("dd/MM/yyyy")
            </p>
        </div>
        <div class="d-flex gap-2">
            @if (ViewBag.DeliveryDate != ViewBag.Today)
            {
                <a asp-action="Index" asp-route-date="@ViewBag.Today.ToString("yyyy-MM-dd")" class="btn btn-outline-secondary">
                    <i class="bi bi-calendar-today me-2"></i>Hôm Nay
                </a>
            }
            <a asp-controller="ShipperDashboard" asp-action="Index" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>Dashboard
            </a>
        </div>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show">
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Orders List -->
    @if (Model == null || !Model.Any())
    {
        <div class="app-card p-5 text-center">
            <i class="bi bi-inbox fs-1 text-muted mb-3"></i>
            <h5 class="text-muted">Không có đơn hàng nào</h5>
            <p class="text-muted">Chưa có đơn hàng nào cần giao cho ngày @ViewBag.DeliveryDate.ToString("dd/MM/yyyy")</p>
        </div>
    }
    else
    {
        <div class="row g-4">
            @foreach (var order in Model)
            {
                var statusClass = order.Status switch
                {
                    OrderStatus.Planned => "bg-info",
                    OrderStatus.Preparing => "bg-warning",
                    OrderStatus.Delivering => "bg-primary",
                    OrderStatus.Delivered => "bg-success",
                    OrderStatus.Cancelled => "bg-danger",
                    _ => "bg-secondary"
                };

                var statusText = order.Status switch
                {
                    OrderStatus.Planned => "Đã Lên Lịch",
                    OrderStatus.Preparing => "Đang Chuẩn Bị",
                    OrderStatus.Delivering => "Đang Giao",
                    OrderStatus.Delivered => "Đã Giao",
                    OrderStatus.Cancelled => "Đã Hủy",
                    _ => order.Status.ToString()
                };

                var deliveredItems = order.Items.Count(i => i.DeliveredAt.HasValue);
                var totalItems = order.Items.Count;
                var allDelivered = deliveredItems == totalItems && totalItems > 0;

                <div class="col-md-6 col-lg-4">
                    <div class="app-card p-4 h-100 @(allDelivered ? "border-success" : "")">
                        <!-- Order Header -->
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h5 class="fw-bold mb-1">Đơn #@order.Id</h5>
                                <span class="badge @statusClass px-3 py-2">@statusText</span>
                            </div>
                            @if (allDelivered)
                            {
                                <i class="bi bi-check-circle-fill text-success fs-4"></i>
                            }
                        </div>

                        <!-- Customer Info -->
                        <div class="mb-3">
                            <div class="d-flex align-items-center gap-2 mb-2">
                                <i class="bi bi-person text-muted"></i>
                                <strong>@(order.Subscription?.CustomerName ?? "N/A")</strong>
                            </div>
                            @if (order.Items.Any() && !string.IsNullOrWhiteSpace(order.Items.First().DeliveryAddress))
                            {
                                <div class="d-flex align-items-start gap-2 mb-2">
                                    <i class="bi bi-geo-alt text-muted mt-1"></i>
                                    <small class="text-muted">@order.Items.First().DeliveryAddress</small>
                                </div>
                            }
                            @if (!string.IsNullOrWhiteSpace(order.Subscription?.AppUser?.PhoneNumber))
                            {
                                <div class="d-flex align-items-center gap-2">
                                    <i class="bi bi-telephone text-muted"></i>
                                    <a href="tel:@order.Subscription.AppUser.PhoneNumber" class="text-decoration-none">
                                        <small>@order.Subscription.AppUser.PhoneNumber</small>
                                    </a>
                                </div>
                            }
                        </div>

                        <!-- Items Summary -->
                        <div class="mb-3 p-3 bg-light rounded">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="fw-semibold">Món ăn:</span>
                                <span class="badge bg-secondary">@totalItems món</span>
                            </div>
                            <div class="progress mb-2" style="height: 8px;">
                                <div class="progress-bar bg-success" 
                                     role="progressbar" 
                                     style="width: @((totalItems > 0 ? (deliveredItems * 100.0 / totalItems) : 0))%">
                                </div>
                            </div>
                            <small class="text-muted">
                                Đã giao: <strong>@deliveredItems/@totalItems</strong>
                            </small>
                        </div>

                        <!-- Actions -->
                        <div class="d-grid gap-2">
                            <a asp-action="Details" asp-route-id="@order.Id" class="btn btn-primary">
                                <i class="bi bi-eye me-2"></i>Xem Chi Tiết
                            </a>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>
