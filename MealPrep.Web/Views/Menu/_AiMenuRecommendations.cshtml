@model MealPrep.Web.ViewModels.AiMenuRecommendationVm

<div class="row g-4">
    <!-- Left Column: AI Recommendations -->
    <div class="col-lg-8">
        <div class="app-card p-4 mb-4">
            <div class="d-flex align-items-center gap-3 mb-4">
                <div class="header-icon">
                    <i class="bi bi-robot" style="font-size: 2rem; color: var(--accent);"></i>
                </div>
                <div>
                    <h4 class="fw-bold mb-1">Menu AI Đề Xuất</h4>
                    <p class="text-muted mb-0">
                        <i class="bi bi-calendar3"></i> Tuần từ @Model.WeekStart.ToString("dd/MM/yyyy") đến @Model.WeekEnd.ToString("dd/MM/yyyy")
                    </p>
                </div>
            </div>

            @foreach (var day in Model.AiRecommendations)
            {
                var isWeekend = day.Day >= 6;
                <div class="app-card p-4 mb-3 day-card @(isWeekend ? "weekend-card" : "")" 
                     style="border-left: 4px solid @(isWeekend ? "var(--accent)" : "var(--primary)");">
                    <!-- Day Header -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-center gap-3">
                            <div class="day-number-circle @(isWeekend ? "bg-accent" : "bg-primary")">
                                @day.Day
                            </div>
                            <div>
                                <h5 class="fw-bold mb-1">@day.DayName</h5>
                                <small class="text-muted">
                                    <i class="bi bi-calendar3"></i> @day.Date.ToString("dd/MM/yyyy")
                                </small>
                            </div>
                        </div>
                        @if (!string.IsNullOrEmpty(day.Reason))
                        {
                            <span class="badge bg-info px-3 py-2" title="@day.Reason">
                                <i class="bi bi-lightbulb"></i> AI
                            </span>
                        }
                    </div>

                    <!-- AI Reason -->
                    @if (!string.IsNullOrEmpty(day.Reason))
                    {
                        <div class="alert alert-info mb-3">
                            <i class="bi bi-info-circle"></i> <strong>Lý do:</strong> @day.Reason
                        </div>
                    }

                    <!-- Recommended Meals -->
                    <div class="row g-3" id="ai-day-@day.Day">
                        @for (int i = 0; i < 2; i++)
                        {
                            var mealType = i == 0 ? "Sáng" : "Chiều";
                            var mealIcon = i == 0 ? "sunrise" : "sunset";
                            var recommendedMeal = day.RecommendedMeals.Count > i ? day.RecommendedMeals[i] : null;
                            
                            <div class="col-md-6 col-lg-4">
                                <label class="form-label fw-bold mb-3 d-block">
                                    <i class="bi bi-@mealIcon text-warning"></i> 
                                    Bữa @mealType <span class="text-danger">*</span>
                                </label>
                                
                                @if (recommendedMeal != null)
                                {
                                    var mealImage = !string.IsNullOrEmpty(recommendedMeal.ImageUrl) 
                                        ? recommendedMeal.ImageUrl 
                                        : "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='300'%3E%3Crect fill='%23e5e7eb' width='400' height='300'/%3E%3Ctext fill='%239ca3af' font-family='Arial' font-size='16' x='50%25' y='50%25' text-anchor='middle' dominant-baseline='middle'%3ENo Image%3C/text%3E%3C/svg%3E";
                                    
                                    <div class="card meal-recommendation-card mb-3" 
                                         id="meal-card-@day.Day-@i"
                                         data-meal-id="@recommendedMeal.MealId"
                                         data-day="@day.Day"
                                         data-slot="@i"
                                         data-date="@day.Date.ToString("yyyy-MM-dd")"
                                         style="border: 2px solid #E5E7EB; border-radius: 12px; transition: all 0.3s;">
                                        <div class="position-relative" style="height: 150px; overflow: hidden; border-radius: 12px 12px 0 0;">
                                            <img src="@mealImage" 
                                                 alt="@recommendedMeal.Name" 
                                                 class="w-100 h-100" 
                                                 style="object-fit: cover;"
                                                 onerror="if(this.src.indexOf('placeholder') === -1) { this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'400\' height=\'300\'%3E%3Crect fill=\'%23e5e7eb\' width=\'400\' height=\'300\'/%3E%3Ctext fill=\'%239ca3af\' font-family=\'Arial\' font-size=\'16\' x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dominant-baseline=\'middle\'%3ENo Image%3C/text%3E%3C/svg%3E'; }" />
                                            @if (recommendedMeal.HasAllergen)
                                            {
                                                <span class="badge bg-warning position-absolute top-0 end-0 m-2" title="@recommendedMeal.AllergenWarning">
                                                    <i class="bi bi-exclamation-triangle"></i>
                                                </span>
                                            }
                                            <div class="position-absolute top-0 start-0 m-2">
                                                <span class="badge bg-success">
                                                    <i class="bi bi-robot"></i> AI Đề Xuất
                                                </span>
                                            </div>
                                            <!-- Selection Checkmark (hidden by default) -->
                                            <div class="position-absolute bottom-0 end-0 m-2" id="checkmark-@day.Day-@i" style="display: none;">
                                                <span class="badge bg-success" style="font-size: 1.2rem; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                                    <i class="bi bi-check-circle-fill"></i>
                                                </span>
                                            </div>
                                        </div>
                                        <div class="card-body p-3">
                                            <h6 class="fw-bold mb-2">@recommendedMeal.Name</h6>
                                            <p class="text-muted small mb-2">@(recommendedMeal.Description?.Length > 60 ? recommendedMeal.Description.Substring(0, 60) + "..." : recommendedMeal.Description ?? "Không có mô tả")</p>
                                            <div class="d-flex gap-1 flex-wrap mb-2">
                                                <span class="badge bg-info" style="font-size: 0.7rem;">
                                                    <i class="bi bi-fire"></i> @recommendedMeal.Calories cal
                                                </span>
                                                <span class="badge bg-primary" style="font-size: 0.7rem;">
                                                    <i class="bi bi-droplet"></i> P:@recommendedMeal.Protein
                                                </span>
                                                <span class="badge bg-success" style="font-size: 0.7rem;">
                                                    <i class="bi bi-grain"></i> C:@recommendedMeal.Carbs
                                                </span>
                                                <span class="badge bg-warning text-dark" style="font-size: 0.7rem;">
                                                    <i class="bi bi-circle"></i> F:@recommendedMeal.Fat
                                                </span>
                                            </div>
                                            <div class="d-flex gap-2">
                                                <a asp-controller="Meal" 
                                                   asp-action="Details" 
                                                   asp-route-id="@recommendedMeal.MealId" 
                                                   target="_blank"
                                                   class="btn btn-sm btn-outline-primary flex-grow-1">
                                                    <i class="bi bi-eye me-1"></i>Xem Chi Tiết
                                                </a>
                                                <button type="button" 
                                                        class="btn btn-sm btn-success"
                                                        id="select-btn-@day.Day-@i"
                                                        onclick="toggleMealSelection(@day.Day, @i, @recommendedMeal.MealId, '@day.Date.ToString("yyyy-MM-dd")')">
                                                    <i class="bi bi-check-circle"></i> Chọn
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Hidden input for form submission (empty by default, only set when selected) -->
                                    <input type="hidden" 
                                           name="aiSelections[@day.Day].MealIds[@i]"
                                           id="ai-meal-input-@day.Day-@i"
                                           value=""
                                           data-date="@day.Date.ToString("yyyy-MM-dd")"
                                           data-selected="false" />
                                }
                                else
                                {
                                    <!-- No recommendation, show dropdown -->
                                    <select class="form-select ai-meal-select shadow-sm" 
                                            name="aiSelections[@day.Day].MealIds[@i]"
                                            id="ai-meal-select-@day.Day-@i"
                                            data-day="@day.Day"
                                            data-slot="@i"
                                            data-date="@day.Date.ToString("yyyy-MM-dd")"
                                            style="border-radius: 10px; border: 2px solid #E5E7EB; transition: all 0.2s;">
                                        <option value="">-- Chọn món --</option>
                                        @foreach (var meal in Model.AvailableMeals)
                                        {
                                            var optionText = $"{meal.Name} ({meal.Calories} cal)";
                                            if (meal.HasAllergen)
                                            {
                                                optionText = $"⚠️ {optionText}";
                                            }
                                            <option value="@meal.MealId" 
                                                    data-allergen="@(meal.HasAllergen ? "true" : "false")"
                                                    data-warning="@meal.AllergenWarning"
                                                    data-calories="@meal.Calories"
                                                    data-protein="@meal.Protein"
                                                    data-carbs="@meal.Carbs"
                                                    data-fat="@meal.Fat"
                                                    title="@meal.AllergenWarning">
                                                @optionText
                                            </option>
                                        }
                                    </select>
                                }
                                
                                <!-- Allergen Warning -->
                                <small class="text-warning d-block mt-2" id="ai-warning-@day.Day-@i" style="display:none;">
                                    <i class="bi bi-exclamation-triangle-fill"></i> 
                                    <span class="warning-text"></span>
                                </small>
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- Accept Button -->
            <div class="d-flex justify-content-end gap-3 mt-4">
                <button type="button" class="btn btn-outline-secondary" onclick="resetAiMenu()">
                    <i class="bi bi-arrow-counterclockwise"></i> Đặt lại
                </button>
                <button type="button" class="btn btn-success btn-lg px-5" onclick="acceptAiMenu()">
                    <i class="bi bi-check-circle-fill"></i> Đồng ý Menu AI
                </button>
            </div>
        </div>
    </div>

    <!-- Right Column: Available Meals -->
    <div class="col-lg-4">
        <div class="app-card p-4 sticky-top" style="top: 20px;">
            <h5 class="fw-bold mb-3">
                <i class="bi bi-list-ul text-primary"></i> Tất cả Món Ăn
            </h5>
            <div class="available-meals-list" style="max-height: 70vh; overflow-y: auto;">
                @foreach (var meal in Model.AvailableMeals)
                {
                    <div class="meal-item-card p-3 mb-2 border rounded" 
                         data-meal-id="@meal.MealId"
                         style="cursor: pointer; transition: all 0.2s;"
                         onmouseover="this.style.backgroundColor='#F9FAFB'" 
                         onmouseout="this.style.backgroundColor='white'">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="fw-semibold mb-0">@meal.Name</h6>
                            @if (meal.HasAllergen)
                            {
                                <span class="badge bg-warning text-dark">
                                    <i class="bi bi-exclamation-triangle"></i>
                                </span>
                            }
                        </div>
                        <p class="text-muted small mb-2">@(meal.Description.Length > 100 ? meal.Description.Substring(0, 100) + "..." : meal.Description)</p>
                        <div class="d-flex gap-2 flex-wrap">
                            <span class="badge bg-info">
                                <i class="bi bi-fire"></i> @meal.Calories cal
                            </span>
                            <span class="badge bg-primary">
                                <i class="bi bi-droplet"></i> @meal.Protein g P
                            </span>
                            <span class="badge bg-warning">
                                <i class="bi bi-grain"></i> @meal.Carbs g C
                            </span>
                            <span class="badge bg-danger">
                                <i class="bi bi-droplet-fill"></i> @meal.Fat g F
                            </span>
                        </div>
                        @if (meal.HasAllergen && !string.IsNullOrEmpty(meal.AllergenWarning))
                        {
                            <small class="text-warning d-block mt-2">
                                <i class="bi bi-exclamation-triangle-fill"></i> @meal.AllergenWarning
                            </small>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<style>
    .meal-recommendation-card {
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .meal-recommendation-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 20px rgba(34, 197, 94, 0.2);
    }
    
    .meal-recommendation-card img {
        transition: transform 0.3s ease;
    }
    
    .meal-recommendation-card:hover img {
        transform: scale(1.05);
    }
    
    .meal-recommendation-card.selected {
        border-color: #22C55E !important;
        background-color: #F0FDF4 !important;
        box-shadow: 0 4px 12px rgba(34, 197, 94, 0.2) !important;
    }
</style>

<script>
    // Initialize AI meal selects
    document.addEventListener('DOMContentLoaded', function() {
        const aiMealSelects = document.querySelectorAll('.ai-meal-select');
        
        aiMealSelects.forEach(select => {
            select.addEventListener('change', function() {
                const option = this.options[this.selectedIndex];
                const hasAllergen = option.dataset.allergen === 'true';
                const warning = option.dataset.warning || '';
                const day = this.dataset.day;
                const slot = this.dataset.slot;
                
                // Allergen warning
                const warningEl = document.getElementById(`ai-warning-${day}-${slot}`);
                if (hasAllergen && warningEl) {
                    warningEl.querySelector('.warning-text').textContent = warning;
                    warningEl.style.display = 'block';
                } else if (warningEl) {
                    warningEl.style.display = 'none';
                }
                
                // Nutrition info
                const nutritionEl = document.getElementById(`ai-nutrition-${day}-${slot}`);
                if (option.value && nutritionEl) {
                    const calories = option.dataset.calories || '0';
                    const protein = option.dataset.protein || '0';
                    
                    nutritionEl.querySelector('.calories-text').textContent = calories;
                    nutritionEl.querySelector('.protein-text').textContent = protein;
                    nutritionEl.style.display = 'block';
                } else if (nutritionEl) {
                    nutritionEl.style.display = 'none';
                }
                
                // Visual feedback
                if (option.value) {
                    this.style.borderColor = hasAllergen ? '#F59E0B' : '#22C55E';
                } else {
                    this.style.borderColor = '#E5E7EB';
                }
            });
            
            // Trigger change event for pre-selected options
            if (select.value) {
                select.dispatchEvent(new Event('change'));
            }
        });
    });

    // Toggle meal selection from AI recommendation card
    function toggleMealSelection(day, slot, mealId, dateStr) {
        const hiddenInput = document.getElementById(`ai-meal-input-${day}-${slot}`);
        const mealCard = document.getElementById(`meal-card-${day}-${slot}`);
        const selectBtn = document.getElementById(`select-btn-${day}-${slot}`);
        const checkmark = document.getElementById(`checkmark-${day}-${slot}`);
        const select = document.getElementById(`ai-meal-select-${day}-${slot}`);
        
        if (!hiddenInput) return;
        
        const isSelected = hiddenInput.dataset.selected === 'true';
        
        if (isSelected) {
            // Deselect: Clear value and update UI
            hiddenInput.value = '';
            hiddenInput.dataset.selected = 'false';
            
            // Update card styling
            if (mealCard) {
                mealCard.style.borderColor = '#E5E7EB';
                mealCard.style.backgroundColor = '';
            }
            
            // Hide checkmark
            if (checkmark) checkmark.style.display = 'none';
            
            // Update button
            if (selectBtn) {
                selectBtn.innerHTML = '<i class="bi bi-check-circle"></i> Chọn';
                selectBtn.classList.remove('btn-outline-success');
                selectBtn.classList.add('btn-success');
            }
        } else {
            // Select: Set value and update UI
            hiddenInput.value = mealId;
            hiddenInput.dataset.selected = 'true';
            
            // Update card styling
            if (mealCard) {
                mealCard.style.borderColor = '#22C55E';
                mealCard.style.backgroundColor = '#F0FDF4';
            }
            
            // Show checkmark
            if (checkmark) checkmark.style.display = 'block';
            
            // Update button
            if (selectBtn) {
                selectBtn.innerHTML = '<i class="bi bi-x-circle"></i> Bỏ Chọn';
                selectBtn.classList.remove('btn-success');
                selectBtn.classList.add('btn-outline-danger');
            }
        }
        
        // If there's a select dropdown, also update it
        if (select && !isSelected) {
            select.value = mealId;
            select.dispatchEvent(new Event('change'));
        } else if (select && isSelected) {
            select.value = '';
            select.dispatchEvent(new Event('change'));
        }
    }

    function acceptAiMenu() {
        const selections = [];
        const dateMap = new Map();
        
        // Collect from hidden inputs (AI recommendations) - only if selected
        document.querySelectorAll('input[id^="ai-meal-input-"]').forEach(input => {
            // Only collect if the input has a value AND is marked as selected
            if (input.value && input.dataset.selected === 'true') {
                const date = input.dataset.date;
                if (!dateMap.has(date)) {
                    dateMap.set(date, []);
                }
                const mealId = parseInt(input.value);
                if (mealId && !dateMap.get(date).includes(mealId)) {
                    dateMap.get(date).push(mealId);
                }
            }
        });
        
        // Collect from selects (manual selections or empty slots)
        document.querySelectorAll('.ai-meal-select').forEach(select => {
            if (select.value) {
                const date = select.dataset.date;
                if (!dateMap.has(date)) {
                    dateMap.set(date, []);
                }
                const mealId = parseInt(select.value);
                if (mealId && !dateMap.get(date).includes(mealId)) {
                    dateMap.get(date).push(mealId);
                }
            }
        });
        
        // Convert map to array
        dateMap.forEach((mealIds, dateStr) => {
            if (mealIds.length > 0) {
                selections.push({
                    Date: dateStr, // ISO format: "yyyy-MM-dd"
                    MealIds: mealIds
                });
            }
        });
        
        if (selections.length === 0) {
            alert('Vui lòng chọn ít nhất một món ăn!');
            return;
        }
        
        // Show loading
        const btn = event.target;
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Đang lưu...';
        
        // Get anti-forgery token from parent page (SelectMeals.cshtml)
        let token = '';
        const tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
        if (!tokenInput) {
            // Try to get from parent window if this is in an iframe/partial
            try {
                if (window.parent && window.parent.document) {
                    const parentToken = window.parent.document.querySelector('input[name="__RequestVerificationToken"]');
                    if (parentToken) token = parentToken.value;
                }
            } catch (e) {
                console.warn('Cannot access parent window token:', e);
            }
        } else {
            token = tokenInput.value;
        }
        
        if (!token) {
            console.warn('Anti-forgery token not found. Request may fail.');
        }
        
        fetch('@Url.Action("AcceptAiMenu", "Menu")', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': token,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ DaySelections: selections })
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    try {
                        return JSON.parse(text);
                    } catch {
                        throw new Error(`HTTP ${response.status}: ${text}`);
                    }
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Show success message and redirect
                alert('Đã lưu menu thành công!');
                window.location.href = '@Url.Action("Index", "Dashboard")';
            } else {
                alert(data.message || 'Có lỗi xảy ra!');
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Có lỗi xảy ra khi lưu menu: ' + error.message);
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        });
    }

    function resetAiMenu() {
        if (confirm('Bạn có chắc muốn đặt lại menu AI?')) {
            // Reset hidden inputs (AI recommendations)
            document.querySelectorAll('input[id^="ai-meal-input-"]').forEach(input => {
                input.value = '';
                input.dataset.selected = 'false';
            });
            
            // Reset meal cards styling
            document.querySelectorAll('[id^="meal-card-"]').forEach(card => {
                card.style.borderColor = '#E5E7EB';
                card.style.backgroundColor = '';
            });
            
            // Hide checkmarks
            document.querySelectorAll('[id^="checkmark-"]').forEach(checkmark => {
                checkmark.style.display = 'none';
            });
            
            // Reset select buttons
            document.querySelectorAll('[id^="select-btn-"]').forEach(btn => {
                btn.innerHTML = '<i class="bi bi-check-circle"></i> Chọn';
                btn.classList.remove('btn-outline-danger');
                btn.classList.add('btn-success');
            });
            
            // Reset selects (manual selections)
            document.querySelectorAll('.ai-meal-select').forEach(select => {
                select.value = '';
                select.style.borderColor = '#E5E7EB';
                select.dispatchEvent(new Event('change'));
            });
        }
    }
</script>
