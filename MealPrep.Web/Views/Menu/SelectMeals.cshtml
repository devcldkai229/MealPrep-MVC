@model MealPrep.Web.ViewModels.WeeklySelectionVm
@{
    ViewData["Title"] = "Chọn Món Ăn Cho Tuần";
}

<div class="container py-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex align-items-center gap-3 mb-3">
                <div class="header-icon">
                    <i class="bi bi-calendar3-range" style="font-size: 2.5rem; color: var(--accent);"></i>
                </div>
                <div>
                    <h2 class="fw-bold mb-1">Chọn Món Ăn Cho Tuần</h2>
                    <p class="text-muted mb-0">
                        <i class="bi bi-utensils"></i> Bạn được chọn <strong class="text-primary">@Model.MealsPerDay bữa/ngày</strong>
                        @if (Model.UserAllergies.Any())
                        {
                            <span class="badge bg-warning text-dark ms-2">
                                <i class="bi bi-exclamation-triangle"></i> Dị ứng: @string.Join(", ", Model.UserAllergies)
                            </span>
                        }
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Alerts -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show mb-4" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i>
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- AI Menu Generation Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="app-card p-4">
                <div class="mb-3">
                    <h5 class="fw-bold mb-2">
                        <i class="bi bi-robot text-primary"></i> Tạo Menu với AI
                    </h5>
                    <p class="text-muted mb-3 small">
                        AI sẽ phân tích hồ sơ dinh dưỡng, sở thích và mục tiêu của bạn để đề xuất menu phù hợp cho 7 ngày.
                    </p>
                    
                    <!-- Optional Notes Input -->
                    <div class="mb-3">
                        <label for="weeklyNotes" class="form-label fw-semibold">
                            <i class="bi bi-chat-left-text text-primary"></i> Tuần này bạn muốn ăn như thế nào? <span class="text-muted small">(Tùy chọn)</span>
                        </label>
                        <textarea 
                            id="weeklyNotes" 
                            class="form-control" 
                            rows="3" 
                            placeholder="Ví dụ: Tuần này tôi muốn ăn cay nhiều hơn, ít ngọt, thích món nướng..."
                            style="border-radius: 10px; border: 2px solid #E5E7EB; transition: all 0.2s;"></textarea>
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i> Nếu bạn không nhập gì, AI sẽ sử dụng sở thích từ hồ sơ dinh dưỡng của bạn.
                        </small>
                    </div>
                </div>
                <div class="text-end">
                    <button type="button" class="btn btn-primary btn-lg px-4" id="generateAiMenuBtn" onclick="generateAiMenu()">
                        <i class="bi bi-magic"></i> Tạo Menu với AI
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Recommendations Container -->
    <div id="aiRecommendationsContainer" style="display: none;"></div>

    <!-- Loading State -->
    <div id="aiLoadingContainer" style="display: none;">
        <div class="app-card p-5 text-center">
            <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h5 class="fw-bold">AI đang phân tích và tạo menu...</h5>
            <p class="text-muted">Vui lòng đợi trong giây lát. Quá trình này có thể mất 30-60 giây.</p>
        </div>
    </div>

    <!-- Weekly Selection Form (Default View) -->
    <div id="manualSelectionForm">
    <form id="mealSelectionForm" method="post" asp-action="SelectMeals">
        @Html.AntiForgeryToken()
        
        <div class="row g-4">
            @foreach (var daySlot in Model.DailySlots)
            {
                var isWeekend = daySlot.DayOfWeek >= 6;
                <div class="col-12">
                    <div class="app-card p-4 day-card @(isWeekend ? "weekend-card" : "")" 
                         style="border-left: 4px solid @(isWeekend ? "var(--accent)" : "var(--primary)");">
                        <!-- Day Header -->
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div class="d-flex align-items-center gap-3">
                                <div class="day-number-circle @(isWeekend ? "bg-accent" : "bg-primary")">
                                    @daySlot.DayOfWeek
                                </div>
                                <div>
                                    <h5 class="fw-bold mb-1">@daySlot.DayName</h5>
                                    <small class="text-muted">
                                        <i class="bi bi-calendar3"></i> @daySlot.Date.ToString("dd/MM/yyyy")
                                    </small>
                                </div>
                            </div>
                            <span class="badge bg-primary px-3 py-2">
                                <i class="bi bi-utensils"></i> @daySlot.SlotsCount bữa
                            </span>
                        </div>

                        <!-- Meal Selection Buttons -->
                        @for (int i = 0; i < daySlot.SlotsCount; i++)
                        {
                            var mealType = i == 0 ? "Sáng" : i == 1 ? "Trưa" : "Tối";
                            var mealIcon = i == 0 ? "sunrise" : i == 1 ? "sun" : "moon";
                            
                            <div class="mb-3">
                                <label class="form-label fw-bold mb-2 d-block">
                                    <i class="bi bi-@mealIcon text-warning"></i> 
                                    Bữa @mealType <span class="text-danger">*</span>
                                </label>
                                
                                <div class="d-flex align-items-center gap-2">
                                    <button type="button" 
                                            class="btn btn-outline-primary btn-select-meal" 
                                            data-date="@daySlot.Date.DayNumber" 
                                            data-slot="@i"
                                            data-bs-toggle="modal" 
                                            data-bs-target="#mealSelectionModal"
                                            onclick="openMealSelectionModal(@daySlot.Date.DayNumber, @i)">
                                        <i class="bi bi-plus-circle me-2"></i>Chọn Món
                                    </button>
                                    
                                    <!-- Selected Meal Display -->
                                    <div id="selected-meal-@daySlot.Date.DayNumber-@i" class="flex-grow-1" style="display:none;">
                                        <div class="d-flex align-items-center gap-2 p-2 border rounded bg-light">
                                            <img id="selected-meal-image-@daySlot.Date.DayNumber-@i" 
                                                 src="" 
                                                 alt="Selected meal" 
                                                 style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px;"
                                                 onerror="if(this.src.indexOf('placeholder') === -1 && this.src.indexOf('data:image') === -1) { this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'400\' height=\'300\'%3E%3Crect fill=\'%23e5e7eb\' width=\'400\' height=\'300\'/%3E%3Ctext fill=\'%239ca3af\' font-family=\'Arial\' font-size=\'16\' x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dominant-baseline=\'middle\'%3ENo Image%3C/text%3E%3C/svg%3E'; }" />
                                            <div class="flex-grow-1">
                                                <div class="fw-semibold" id="selected-meal-name-@daySlot.Date.DayNumber-@i"></div>
                                                <small class="text-muted" id="selected-meal-info-@daySlot.Date.DayNumber-@i"></small>
                                            </div>
                                            <button type="button" 
                                                    class="btn btn-sm btn-outline-danger" 
                                                    onclick="clearMealSelection(@daySlot.Date.DayNumber, @i)">
                                                <i class="bi bi-x"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Hidden radio input for form submission -->
                                    <input type="hidden" 
                                           name="selections[@daySlot.Date.DayNumber].SelectedMealIds[@i]" 
                                           id="meal-input-@daySlot.Date.DayNumber-@i" 
                                           value="" />
                                </div>
                                
                                <!-- Allergen Warning for this slot -->
                                <div id="warning-@daySlot.Date.DayNumber-@i" class="alert alert-warning mt-2" style="display:none;">
                                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                    <span class="warning-text"></span>
                                </div>
                            </div>
                        }

                        <input type="hidden" name="selections[@daySlot.Date.DayNumber].Date" value="@daySlot.Date.ToString("yyyy-MM-dd")" />
                    </div>
                </div>
            }
        </div>

        <!-- Action Buttons -->
        <div class="row mt-5">
            <div class="col-12">
                <div class="app-card p-4 bg-light">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                        <a asp-controller="Dashboard" asp-action="Index" class="btn btn-outline-secondary btn-lg">
                            <i class="bi bi-arrow-left"></i> Quay lại Dashboard
                        </a>
                        <div class="d-flex align-items-center gap-3">
                            <div class="text-muted small d-none d-md-block">
                                <i class="bi bi-info-circle"></i> Bạn có thể thay đổi lựa chọn bất cứ lúc nào
                            </div>
                            <button type="submit" class="btn btn-primary btn-lg px-5">
                                <i class="bi bi-check-circle-fill"></i> Lưu Lựa Chọn
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
    </div>
</div>

<style>
    .day-card {
        transition: all 0.3s ease;
    }
    
    .day-card:hover {
        box-shadow: 0 12px 30px rgba(17,24,39,.08) !important;
        transform: translateY(-2px);
    }
    
    .weekend-card {
        background: linear-gradient(135deg, #FFFFFF 0%, #F9FAFB 100%);
    }
    
    .day-number-circle {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 1.25rem;
    }
    
    .bg-accent {
        background: var(--accent) !important;
    }
    
    .meal-selection-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.1) !important;
    }
    
    .meal-selection-card.selected {
        border-color: #22C55E !important;
        box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3) !important;
    }
    
    .meal-selection-card.has-allergen {
        border-color: #F59E0B !important;
    }
    
    .nutrition-info {
        animation: fadeInAnimation 0.3s ease;
    }
    
    @@keyframes fadeInAnimation {
        from { 
            opacity: 0; 
            transform: translateY(-5px); 
        }
        to { 
            opacity: 1; 
            transform: translateY(0); 
        }
    }
    
    .header-icon {
        animation: pulseAnimation 2s infinite;
    }
    
    @@keyframes pulseAnimation {
        0%, 100% { 
            transform: scale(1); 
        }
        50% { 
            transform: scale(1.05); 
        }
    }
</style>

@section Scripts {
    <script>
        // Function to handle meal selection
        function selectMeal(cardElement, date, slot, mealId) {
            // Find the radio button in this card
            const radio = cardElement.querySelector(`input[type="radio"][value="${mealId}"]`);
            if (radio) {
                radio.checked = true;
                
                // Trigger change event to show warnings
                radio.dispatchEvent(new Event('change', { bubbles: true }));
                
                // Visual feedback - highlight selected card
                const slotContainer = document.getElementById(`day-${date}-slot-${slot}`);
                if (slotContainer) {
                    slotContainer.querySelectorAll('.meal-selection-card').forEach(card => {
                        card.style.borderColor = '#E5E7EB';
                        card.style.boxShadow = 'none';
                    });
                }
                cardElement.style.borderColor = '#22C55E';
                cardElement.style.boxShadow = '0 4px 12px rgba(34, 197, 94, 0.3)';
            }
        }

        function generateAiMenu() {
            const btn = document.getElementById('generateAiMenuBtn');
            const loadingContainer = document.getElementById('aiLoadingContainer');
            const recommendationsContainer = document.getElementById('aiRecommendationsContainer');
            const manualForm = document.getElementById('manualSelectionForm');
            const weeklyNotesInput = document.getElementById('weeklyNotes');
            
            // Get optional notes
            const weeklyNotes = weeklyNotesInput?.value?.trim() || '';
            
            // Show loading, hide other sections
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Đang tạo...';
            loadingContainer.style.display = 'block';
            recommendationsContainer.style.display = 'none';
            manualForm.style.display = 'none';
            
            // Scroll to loading
            loadingContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            // Prepare form data
            const formData = new FormData();
            formData.append('weeklyNotes', weeklyNotes);
            formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]')?.value || '');
            
            // Call API
            fetch('@Url.Action("GenerateAiMenu", "Menu")', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    return response.text();
                }
                return response.json().then(data => {
                    throw new Error(data.message || 'Lỗi khi tạo menu AI');
                });
            })
            .then(html => {
                // Hide loading, show recommendations
                loadingContainer.style.display = 'none';
                recommendationsContainer.innerHTML = html;
                recommendationsContainer.style.display = 'block';
                manualForm.style.display = 'none';
                
                // Scroll to recommendations
                recommendationsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Lỗi khi tạo menu AI: ' + error.message);
                loadingContainer.style.display = 'none';
                manualForm.style.display = 'block';
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-magic"></i> Tạo Menu với AI';
            });
        }

        // Modal state
        let currentDate = null;
        let currentSlot = null;
        let currentPage = 1;
        let currentSearch = '';
        let totalPages = 1;

        // Open meal selection modal
        function openMealSelectionModal(date, slot) {
            currentDate = date;
            currentSlot = slot;
            currentPage = 1;
            currentSearch = '';
            document.getElementById('mealSearchInput').value = '';
            loadMeals();
        }

        // Load meals with search and pagination
        async function loadMeals() {
            const container = document.getElementById('mealsListContainer');
            container.innerHTML = '<div class="col-12 text-center py-4"><div class="spinner-border text-primary" role="status"></div></div>';

            try {
                const response = await fetch(`@Url.Action("GetMealsForSelection", "Menu")?search=${encodeURIComponent(currentSearch)}&page=${currentPage}&pageSize=4`);
                const data = await response.json();

                totalPages = data.totalPages;
                currentPage = data.page;

                // Render meals
                if (data.meals && data.meals.length > 0) {
                    container.innerHTML = data.meals.map(meal => `
                        <div class="col-md-6">
                            <div class="card h-100 meal-option-card" style="cursor: pointer;" onclick="selectMealFromModal(${meal.mealId}, '${meal.name.replace(/'/g, "\\'")}', '${meal.imageUrl || ''}', ${meal.calories}, ${meal.protein}, ${meal.carbs}, ${meal.fat}, ${meal.hasAllergen}, '${meal.allergenWarning.replace(/'/g, "\\'")}')">
                                <div class="position-relative" style="height: 150px; overflow: hidden;">
                                    <img src="${meal.imageUrl || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'400\' height=\'300\'%3E%3Crect fill=\'%23e5e7eb\' width=\'400\' height=\'300\'/%3E%3Ctext fill=\'%239ca3af\' font-family=\'Arial\' font-size=\'16\' x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dominant-baseline=\'middle\'%3ENo Image%3C/text%3E%3C/svg%3E'}" 
                                         alt="${meal.name}" 
                                         class="w-100 h-100" 
                                         style="object-fit: cover;"
                                         onerror="if(this.src.indexOf('data:image') === -1) { this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'400\' height=\'300\'%3E%3Crect fill=\'%23e5e7eb\' width=\'400\' height=\'300\'/%3E%3Ctext fill=\'%239ca3af\' font-family=\'Arial\' font-size=\'16\' x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dominant-baseline=\'middle\'%3ENo Image%3C/text%3E%3C/svg%3E'; }" />
                                    ${meal.hasAllergen ? '<span class="badge bg-warning position-absolute top-0 end-0 m-2"><i class="bi bi-exclamation-triangle"></i></span>' : ''}
                                </div>
                                <div class="card-body p-3">
                                    <h6 class="fw-bold mb-2">${meal.name}</h6>
                                    <p class="text-muted small mb-2">${meal.description.length > 60 ? meal.description.substring(0, 60) + '...' : meal.description}</p>
                                    <div class="d-flex gap-1 flex-wrap">
                                        <span class="badge bg-info" style="font-size: 0.7rem;"><i class="bi bi-fire"></i> ${meal.calories} cal</span>
                                        <span class="badge bg-primary" style="font-size: 0.7rem;">P:${meal.protein}</span>
                                        <span class="badge bg-success" style="font-size: 0.7rem;">C:${meal.carbs}</span>
                                        <span class="badge bg-warning text-dark" style="font-size: 0.7rem;">F:${meal.fat}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div class="col-12 text-center py-4 text-muted">Không tìm thấy món ăn nào.</div>';
                }

                // Update pagination
                updatePagination();
            } catch (error) {
                console.error('Error loading meals:', error);
                container.innerHTML = '<div class="col-12 text-center py-4 text-danger">Có lỗi xảy ra khi tải danh sách món ăn.</div>';
            }
        }

        // Update pagination controls
        function updatePagination() {
            const pagination = document.getElementById('mealsPagination');
            const pageInfo = document.getElementById('pageInfo');
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');

            if (totalPages > 1) {
                pagination.style.display = 'flex';
                pageInfo.textContent = `Trang ${currentPage} / ${totalPages}`;
                prevBtn.disabled = currentPage <= 1;
                nextBtn.disabled = currentPage >= totalPages;
            } else {
                pagination.style.display = 'none';
            }
        }

        // Change page
        function changeMealPage(direction) {
            const newPage = currentPage + direction;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                loadMeals();
            }
        }

        // Handle search with debounce
        let searchTimeout;
        function handleMealSearch(event) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentSearch = event.target.value;
                currentPage = 1;
                loadMeals();
            }, 500);
        }

        // Select meal from modal
        function selectMealFromModal(mealId, mealName, imageUrl, calories, protein, carbs, fat, hasAllergen, allergenWarning) {
            // Update hidden input
            document.getElementById(`meal-input-${currentDate}-${currentSlot}`).value = mealId;

            // Update selected meal display
            const selectedDiv = document.getElementById(`selected-meal-${currentDate}-${currentSlot}`);
            const selectedImage = document.getElementById(`selected-meal-image-${currentDate}-${currentSlot}`);
            const selectedName = document.getElementById(`selected-meal-name-${currentDate}-${currentSlot}`);
            const selectedInfo = document.getElementById(`selected-meal-info-${currentDate}-${currentSlot}`);
            const selectButton = document.querySelector(`button[data-date="${currentDate}"][data-slot="${currentSlot}"]`);

            selectedImage.src = imageUrl || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'400\' height=\'300\'%3E%3Crect fill=\'%23e5e7eb\' width=\'400\' height=\'300\'/%3E%3Ctext fill=\'%239ca3af\' font-family=\'Arial\' font-size=\'16\' x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dominant-baseline=\'middle\'%3ENo Image%3C/text%3E%3C/svg%3E';
            selectedName.textContent = mealName;
            selectedInfo.textContent = `${calories} cal • P:${protein} C:${carbs} F:${fat}`;
            selectedDiv.style.display = 'flex';
            selectButton.style.display = 'none';

            // Show allergen warning if needed
            const warningEl = document.getElementById(`warning-${currentDate}-${currentSlot}`);
            if (hasAllergen && allergenWarning) {
                if (warningEl) {
                    warningEl.querySelector('.warning-text').textContent = allergenWarning;
                    warningEl.style.display = 'block';
                }
            } else if (warningEl) {
                warningEl.style.display = 'none';
            }

            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('mealSelectionModal'));
            if (modal) {
                modal.hide();
            }
        }

        // Clear meal selection
        function clearMealSelection(date, slot) {
            document.getElementById(`meal-input-${date}-${slot}`).value = '';
            document.getElementById(`selected-meal-${date}-${slot}`).style.display = 'none';
            const selectButton = document.querySelector(`button[data-date="${date}"][data-slot="${slot}"]`);
            if (selectButton) {
                selectButton.style.display = 'inline-block';
            }
            const warningEl = document.getElementById(`warning-${date}-${slot}`);
            if (warningEl) {
                warningEl.style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('mealSelectionForm');

            // Form submission with loading state
            form.addEventListener('submit', function(e) {
                const submitBtn = form.querySelector('button[type="submit"]');
                const originalHtml = submitBtn.innerHTML;
                
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Đang lưu...';
                
                // Re-enable after 10 seconds as fallback
                setTimeout(() => {
                    if (submitBtn.disabled) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalHtml;
                    }
                }, 10000);
            });
            
            // Reset modal when closed
            const modal = document.getElementById('mealSelectionModal');
            if (modal) {
                modal.addEventListener('hidden.bs.modal', function() {
                    currentDate = null;
                    currentSlot = null;
                    currentPage = 1;
                    currentSearch = '';
                });
            }
        });
    </script>
}
