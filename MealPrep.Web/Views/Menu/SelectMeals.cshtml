@model MealPrep.Web.ViewModels.WeeklySelectionVm
@{
    ViewData["Title"] = "Chọn Món Ăn Cho Tuần";
}

<div class="meal-selection-page">
    <div class="container py-5">
        <!-- Header -->
        <div class="page-header mb-5">
            <h1 class="page-title">Chọn Món Ăn Cho Tuần</h1>
            <p class="page-subtitle">
                Chọn <strong>@Model.MealsPerDay bữa/ngày</strong> cho 7 ngày tiếp theo
                @if (Model.UserAllergies.Any())
                {
                    <span class="allergy-badge">
                        <i class="bi bi-exclamation-circle"></i> Dị ứng: @string.Join(", ", Model.UserAllergies)
                    </span>
                }
            </p>
        </div>

        <!-- Alerts -->
        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show mb-4" role="alert">
                <i class="bi bi-check-circle me-2"></i>
                @TempData["SuccessMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }
        @if (TempData["ErrorMessage"] != null)
        {
            <div class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
                <i class="bi bi-exclamation-circle me-2"></i>
                @TempData["ErrorMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }

        <!-- AI Menu Generation -->
        <div class="ai-section mb-5">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <div class="d-flex align-items-start justify-content-between mb-3">
                        <div class="flex-grow-1">
                            <h5 class="mb-2 fw-semibold">Tạo Menu với AI</h5>
                            <p class="text-muted small mb-0">AI sẽ đề xuất menu phù hợp dựa trên hồ sơ dinh dưỡng của bạn</p>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="weeklyNotes" class="form-label small text-muted mb-2">Ghi chú (tùy chọn)</label>
                        <textarea id="weeklyNotes" class="form-control" rows="2" 
                                  placeholder="Ví dụ: Tuần này muốn ăn cay nhiều hơn, ít ngọt..."></textarea>
                    </div>
                    <button type="button" class="btn btn-primary" id="generateAiMenuBtn" onclick="generateAiMenu()">
                        <i class="bi bi-magic me-2"></i>Tạo Menu với AI
                    </button>
                </div>
            </div>
        </div>

        <!-- AI Recommendations Container -->
        <div id="aiRecommendationsContainer" style="display: none;"></div>

        <!-- Loading State -->
        <div id="aiLoadingContainer" style="display: none;">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-5 text-center">
                    <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h6 class="fw-semibold mb-2">AI đang phân tích và tạo menu...</h6>
                    <p class="text-muted small mb-0">Vui lòng đợi trong giây lát</p>
                </div>
            </div>
        </div>

        <!-- Weekly Selection Form -->
        <div id="manualSelectionForm">
            <form id="mealSelectionForm" method="post" asp-action="SelectMeals">
                @Html.AntiForgeryToken()
                
                <div class="days-container">
                    @{
                        int dayIndex = 0;
                    }
                    @foreach (var daySlot in Model.DailySlots)
                    {
                        dayIndex++;
                        var isWeekend = daySlot.DayOfWeek >= 6;
                        
                        <div class="day-card mb-4">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body p-4">
                                    <!-- Day Header -->
                                    <div class="day-header mb-4">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <div class="d-flex align-items-center gap-3">
                                                <div class="day-number">@dayIndex</div>
                                                <div>
                                                    <h6 class="mb-0 fw-semibold">@daySlot.DayName</h6>
                                                    <small class="text-muted">@daySlot.Date.ToString("dd/MM/yyyy")</small>
                                                </div>
                                            </div>
                                            <div class="d-flex align-items-center gap-2">
                                                @if (daySlot.IsPastCutoff)
                                                {
                                                    <span class="badge bg-danger">
                                                        <i class="bi bi-clock me-1"></i>Đã Quá Giờ Chốt
                                                    </span>
                                                }
                                                else if (daySlot.IsLocked)
                                                {
                                                    <span class="badge bg-secondary">
                                                        <i class="bi bi-lock me-1"></i>Đã Khóa
                                                    </span>
                                                }
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Meal Slots -->
                                    <div class="meal-slots">
                                        @for (int i = 0; i < daySlot.SlotsCount; i++)
                                        {
                                            var mealType = i == 0 ? "Sáng" : i == 1 ? "Chiều" : "Tối";
                                            
                                            var lockedMeal = daySlot.LockedMeals.FirstOrDefault(m => m.SlotIndex == i);
                                            var isSlotLocked = (daySlot.IsLocked || daySlot.IsPastCutoff) && lockedMeal != null;
                                            var isDisabled = daySlot.IsLocked || daySlot.IsPastCutoff;
                                            
                                            <div class="meal-slot mb-3">
                                                <label class="meal-slot-label mb-2">
                                                    Bữa @mealType <span class="text-danger">*</span>
                                                </label>
                                                
                                                @if (isSlotLocked)
                                                {
                                                    <div class="locked-meal">
                                                        <div class="d-flex align-items-center gap-2 p-3 bg-light rounded">
                                                            <i class="bi bi-lock text-muted"></i>
                                                            <div class="flex-grow-1">
                                                                <div class="fw-semibold small">@lockedMeal.MealName</div>
                                                                <small class="text-muted">Đã được xác nhận</small>
                                                            </div>
                                                        </div>
                                                        <input type="hidden" 
                                                               name="selections[@daySlot.Date.DayNumber].SelectedMealIds[@i]" 
                                                               id="meal-input-@daySlot.Date.DayNumber-@i" 
                                                               value="@lockedMeal.MealId"
                                                               data-locked="true" />
                                                    </div>
                                                }
                                                else if (isDisabled)
                                                {
                                                    <div class="disabled-meal">
                                                        <div class="d-flex align-items-center gap-2 p-3 bg-light rounded border border-danger">
                                                            <i class="bi bi-clock-history text-danger"></i>
                                                            <div class="flex-grow-1">
                                                                <small class="text-muted">
                                                                    Không thể chỉnh sửa vì đã qua thời hạn thay đổi cho ngày này.
                                                                </small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="meal-selection">
                                                        <button type="button" 
                                                                class="btn btn-outline-secondary w-100 d-flex align-items-center justify-content-between"
                                                                data-date="@daySlot.Date.DayNumber" 
                                                                data-slot="@i"
                                                                data-date-string="@daySlot.Date.ToString("yyyy-MM-dd")"
                                                                data-bs-toggle="modal" 
                                                                data-bs-target="#mealSelectionModal"
                                                                onclick="openMealSelectionModal(@daySlot.Date.DayNumber, @i, '@daySlot.Date.ToString("yyyy-MM-dd")')">
                                                            <span>
                                                                <i class="bi bi-plus-circle me-2"></i>Chọn món
                                                            </span>
                                                            <i class="bi bi-chevron-right text-muted"></i>
                                                        </button>
                                                        
                                                        <div id="selected-meal-@daySlot.Date.DayNumber-@i" class="selected-meal mt-2" style="display:none;">
                                                            <div class="d-flex align-items-center gap-3 p-3 bg-light rounded">
                                                                <img id="selected-meal-image-@daySlot.Date.DayNumber-@i" 
                                                                     src="" 
                                                                     alt="Selected meal" 
                                                                     class="selected-meal-image"
                                                                     onerror="if(this.src.indexOf('data:image') === -1) { this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'60\' height=\'60\'%3E%3Crect fill=\'%23e5e7eb\' width=\'60\' height=\'60\'/%3E%3Ctext fill=\'%239ca3af\' font-family=\'Arial\' font-size=\'10\' x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dominant-baseline=\'middle\'%3ENo Image%3C/text%3E%3C/svg%3E'; }" />
                                                                <div class="flex-grow-1">
                                                                    <div class="fw-semibold small" id="selected-meal-name-@daySlot.Date.DayNumber-@i"></div>
                                                                    <small class="text-muted" id="selected-meal-info-@daySlot.Date.DayNumber-@i"></small>
                                                                </div>
                                                                <button type="button" 
                                                                        class="btn btn-sm btn-link text-danger p-0" 
                                                                        onclick="clearMealSelection(@daySlot.Date.DayNumber, @i)">
                                                                    <i class="bi bi-x-lg"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                        
                                                        <input type="hidden" 
                                                               name="selections[@daySlot.Date.DayNumber].SelectedMealIds[@i]" 
                                                               id="meal-input-@daySlot.Date.DayNumber-@i" 
                                                               value="" />
                                                        
                                                        <div id="warning-@daySlot.Date.DayNumber-@i" class="alert alert-warning mt-2 py-2 px-3 small" style="display:none;">
                                                            <i class="bi bi-exclamation-triangle me-1"></i>
                                                            <span class="warning-text"></span>
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                        }
                                    </div>

                                    <input type="hidden" name="selections[@daySlot.Date.DayNumber].Date" value="@daySlot.Date.ToString("yyyy-MM-dd")" />
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <!-- Delivery Address Section -->
                @if (!Model.HasDeliveryAddress)
                {
                    <div class="delivery-address-section mt-5">
                        <div class="card border-0 shadow-sm border-warning">
                            <div class="card-body p-4">
                                <div class="d-flex align-items-start mb-3">
                                    <i class="bi bi-geo-alt-fill text-warning fs-4 me-3"></i>
                                    <div class="flex-grow-1">
                                        <h5 class="fw-semibold mb-2">Địa Chỉ Giao Hàng</h5>
                                        <p class="text-muted small mb-0">
                                            Vui lòng nhập địa chỉ giao hàng để chúng tôi có thể giao món ăn đến đúng địa chỉ của bạn.
                                            Địa chỉ này sẽ được lưu vào hồ sơ của bạn cho các lần đặt hàng sau.
                                        </p>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="deliveryAddress" class="form-label fw-semibold">
                                        Địa chỉ giao hàng <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" 
                                           class="form-control @(ViewData.ModelState["DeliveryAddress"]?.Errors.Count > 0 ? "is-invalid" : "")" 
                                           id="deliveryAddress" 
                                           name="DeliveryAddress" 
                                           placeholder="Ví dụ: Số 10, Đường Nguyễn Huệ, Quận 1, TP.HCM" 
                                           value="@Model.DeliveryAddress"
                                           required>
                                    @if (ViewData.ModelState["DeliveryAddress"]?.Errors.Count > 0)
                                    {
                                        <div class="invalid-feedback">
                                            @(ViewData.ModelState["DeliveryAddress"]?.Errors.First().ErrorMessage ?? "")
                                        </div>
                                    }
                                    <small class="text-muted">Địa chỉ này sẽ được sử dụng cho tất cả các đơn hàng của bạn</small>
                                </div>
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <!-- User đã có địa chỉ trong hồ sơ: giữ ẩn nhưng vẫn gắn id để AI menu lấy được -->
                    <input type="hidden"
                           id="deliveryAddress"
                           name="DeliveryAddress"
                           value="@Model.DeliveryAddress" />
                }

                <!-- Action Buttons -->
                <div class="action-bar mt-5">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                                <a asp-controller="Dashboard" asp-action="Index" class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-left me-2"></i>Quay lại
                                </a>
                                <button type="submit" class="btn btn-primary btn-lg px-5">
                                    <i class="bi bi-check-lg me-2"></i>Lưu Lựa Chọn
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Meal Selection Modal -->
<div class="modal fade" id="mealSelectionModal" tabindex="-1" aria-labelledby="mealSelectionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content border-0">
            <div class="modal-header border-bottom">
                <h5 class="modal-title fw-semibold" id="mealSelectionModalLabel">Chọn Món Ăn</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <!-- Search Bar -->
                <div class="mb-4">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0">
                            <i class="bi bi-search text-muted"></i>
                        </span>
                        <input type="text" 
                               class="form-control border-start-0 ps-0" 
                               id="mealSearchInput" 
                               placeholder="Tìm kiếm món ăn..." 
                               oninput="handleMealSearch(event)">
                    </div>
                </div>

                <!-- Meals Grid -->
                <div class="row g-3" id="mealsListContainer">
                    <!-- Meals will be loaded here -->
                </div>

                <!-- Pagination -->
                <div class="d-flex justify-content-between align-items-center mt-4" id="mealsPagination" style="display: none;">
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="prevPageBtn" onclick="changeMealPage(-1)">
                        <i class="bi bi-chevron-left"></i> Trước
                    </button>
                    <span class="text-muted small" id="pageInfo">Trang 1 / 1</span>
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="nextPageBtn" onclick="changeMealPage(1)">
                        Sau <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .meal-selection-page {
        background: #f8f9fa;
        min-height: 100vh;
    }

    .page-header {
        text-align: center;
    }

    .page-title {
        font-size: 2rem;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 0.5rem;
    }

    .page-subtitle {
        color: #6b7280;
        font-size: 0.95rem;
        margin-bottom: 0;
    }

    .allergy-badge {
        display: inline-block;
        background: #fef3c7;
        color: #92400e;
        padding: 0.25rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        margin-left: 0.5rem;
    }

    .day-number {
        width: 40px;
        height: 40px;
        border-radius: 0.5rem;
        background: #1f2937;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 1.1rem;
    }

    .day-card .card {
        transition: box-shadow 0.2s ease;
    }

    .day-card .card:hover {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06) !important;
    }

    .meal-slot-label {
        font-size: 0.875rem;
        font-weight: 500;
        color: #374151;
        display: block;
    }

    .selected-meal-image {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 0.375rem;
    }

    .meal-option-card {
        transition: all 0.2s ease;
        border: 1px solid #e5e7eb;
    }
    
    .meal-option-card:hover {
        border-color: #1f2937;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .btn-primary {
        background: #1f2937;
        border-color: #1f2937;
    }

    .btn-primary:hover {
        background: #111827;
        border-color: #111827;
    }

    .btn-outline-secondary {
        border-color: #d1d5db;
        color: #374151;
    }

    .btn-outline-secondary:hover {
        background: #f3f4f6;
        border-color: #9ca3af;
        color: #1f2937;
    }

    .badge {
        font-weight: 500;
        font-size: 0.75rem;
        padding: 0.375rem 0.75rem;
    }

    .card {
        border-radius: 0.5rem;
    }

    .modal-content {
        border-radius: 0.75rem;
    }

    .modal-header {
        padding: 1.25rem 1.5rem;
    }

    .modal-body {
        padding: 1.5rem;
    }

    .input-group-text {
        border-color: #d1d5db;
    }

    .form-control {
        border-color: #d1d5db;
    }

    .form-control:focus {
        border-color: #1f2937;
        box-shadow: 0 0 0 0.2rem rgba(31, 41, 55, 0.1);
    }
</style>

@section Scripts {
    <script>
        // Function to handle meal selection
        function selectMeal(cardElement, date, slot, mealId) {
            const radio = cardElement.querySelector(`input[type="radio"][value="${mealId}"]`);
            if (radio) {
                radio.checked = true;
                radio.dispatchEvent(new Event('change', { bubbles: true }));
            }
        }

        function generateAiMenu() {
            const btn = document.getElementById('generateAiMenuBtn');
            const loadingContainer = document.getElementById('aiLoadingContainer');
            const recommendationsContainer = document.getElementById('aiRecommendationsContainer');
            const manualForm = document.getElementById('manualSelectionForm');
            const weeklyNotesInput = document.getElementById('weeklyNotes');
            
            const weeklyNotes = weeklyNotesInput?.value?.trim() || '';
            
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Đang tạo...';
            loadingContainer.style.display = 'block';
            recommendationsContainer.style.display = 'none';
            manualForm.style.display = 'none';
            
            loadingContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            const formData = new FormData();
            formData.append('weeklyNotes', weeklyNotes);
            formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]')?.value || '');
            
            fetch('@Url.Action("GenerateAiMenu", "Menu")', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    return response.text();
                }
                return response.json().then(data => {
                    throw new Error(data.message || 'Lỗi khi tạo menu AI');
                });
            })
            .then(html => {
                loadingContainer.style.display = 'none';
                recommendationsContainer.innerHTML = html;
                recommendationsContainer.style.display = 'block';
                manualForm.style.display = 'none';
                
                // Execute any scripts in the loaded HTML
                const scripts = recommendationsContainer.querySelectorAll('script');
                scripts.forEach(oldScript => {
                    const newScript = document.createElement('script');
                    Array.from(oldScript.attributes).forEach(attr => {
                        newScript.setAttribute(attr.name, attr.value);
                    });
                    newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                    oldScript.parentNode.replaceChild(newScript, oldScript);
                });
                
                recommendationsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Lỗi khi tạo menu AI: ' + error.message);
                loadingContainer.style.display = 'none';
                manualForm.style.display = 'block';
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-magic me-2"></i>Tạo Menu với AI';
            });
        }

        // Modal state
        let currentDate = null;
        let currentSlot = null;
        let currentPage = 1;
        let currentSearch = '';
        let totalPages = 1;
        let currentDateString = '';
        
        function openMealSelectionModal(date, slot, dateString) {
            currentDate = date;
            currentSlot = slot;
            currentPage = 1;
            currentSearch = '';
            currentDateString = dateString || '';
            document.getElementById('mealSearchInput').value = '';
            loadMeals();
        }

        async function loadMeals() {
            const container = document.getElementById('mealsListContainer');
            container.innerHTML = '<div class="col-12 text-center py-5"><div class="spinner-border text-primary" role="status"></div></div>';

            try {
                const url = `@Url.Action("GetMealsForSelection", "Menu")?search=${encodeURIComponent(currentSearch)}&page=${currentPage}&pageSize=4${currentDateString ? '&date=' + encodeURIComponent(currentDateString) : ''}`;
                const response = await fetch(url);
                const data = await response.json();

                totalPages = data.totalPages;
                currentPage = data.page;

                if (data.meals && data.meals.length > 0) {
                    container.innerHTML = data.meals.map(meal => {
                        const isSoldOut = meal.isSoldOut === true;
                        const availableQty = meal.availableQuantity !== null && meal.availableQuantity !== undefined ? meal.availableQuantity : null;
                        const cardStyle = isSoldOut ? 'opacity: 0.6; cursor: not-allowed;' : 'cursor: pointer;';
                        const onClick = isSoldOut ? '' : `onclick="selectMealFromModal(${meal.mealId}, '${meal.name.replace(/'/g, "\\'")}', '${meal.imageUrl || ''}', ${meal.calories}, ${meal.protein}, ${meal.carbs}, ${meal.fat}, ${meal.hasAllergen}, '${(meal.allergenWarning || '').replace(/'/g, "\\'")}')"`;
                        
                        return `
                        <div class="col-md-6">
                            <div class="card meal-option-card h-100 ${isSoldOut ? 'border-danger' : ''}" style="${cardStyle}" ${onClick}>
                                <div class="position-relative" style="height: 180px; overflow: hidden;">
                                    <img src="${meal.imageUrl || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'400\' height=\'300\'%3E%3Crect fill=\'%23e5e7eb\' width=\'400\' height=\'300\'/%3E%3Ctext fill=\'%239ca3af\' font-family=\'Arial\' font-size=\'16\' x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dominant-baseline=\'middle\'%3ENo Image%3C/text%3E%3C/svg%3E'}" 
                                         alt="${meal.name}" 
                                         class="w-100 h-100" 
                                         style="object-fit: cover;"
                                         onerror="if(this.src.indexOf('data:image') === -1) { this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'400\' height=\'300\'%3E%3Crect fill=\'%23e5e7eb\' width=\'400\' height=\'300\'/%3E%3Ctext fill=\'%239ca3af\' font-family=\'Arial\' font-size=\'16\' x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dominant-baseline=\'middle\'%3ENo Image%3C/text%3E%3C/svg%3E'; }" />
                                    ${isSoldOut ? '<span class="badge bg-danger position-absolute top-0 start-0 m-2"><i class="bi bi-x-circle"></i> Hết Hàng</span>' : ''}
                                    ${meal.hasAllergen ? '<span class="badge bg-warning text-dark position-absolute top-0 end-0 m-2"><i class="bi bi-exclamation-triangle"></i></span>' : ''}
                                </div>
                                <div class="card-body p-3">
                                    <h6 class="fw-semibold mb-2">${meal.name}</h6>
                                    <p class="text-muted small mb-2" style="font-size: 0.8rem;">${meal.description.length > 60 ? meal.description.substring(0, 60) + '...' : meal.description}</p>
                                    <div class="d-flex gap-1 flex-wrap mb-2">
                                        <span class="badge bg-secondary" style="font-size: 0.7rem;">${meal.calories} cal</span>
                                        <span class="badge bg-secondary" style="font-size: 0.7rem;">P:${meal.protein}</span>
                                        <span class="badge bg-secondary" style="font-size: 0.7rem;">C:${meal.carbs}</span>
                                        <span class="badge bg-secondary" style="font-size: 0.7rem;">F:${meal.fat}</span>
                                    </div>
                                    ${availableQty !== null ? `<div class="d-flex align-items-center gap-1">
                                        <small class="text-muted">Còn lại: <strong class="${availableQty <= 5 ? 'text-danger' : availableQty <= 10 ? 'text-warning' : 'text-success'}">${availableQty} suất</strong></small>
                                    </div>` : ''}
                                    ${isSoldOut ? '<div class="alert alert-danger mt-2 mb-0 py-1 px-2 small"><i class="bi bi-exclamation-circle"></i> Món này đã hết hàng</div>' : ''}
                                </div>
                            </div>
                        </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<div class="col-12 text-center py-5 text-muted">Không tìm thấy món ăn nào.</div>';
                }

                updatePagination();
            } catch (error) {
                console.error('Error loading meals:', error);
                container.innerHTML = '<div class="col-12 text-center py-5 text-danger">Có lỗi xảy ra khi tải danh sách món ăn.</div>';
            }
        }

        function updatePagination() {
            const pagination = document.getElementById('mealsPagination');
            const pageInfo = document.getElementById('pageInfo');
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');

            if (totalPages > 1) {
                pagination.style.display = 'flex';
                pageInfo.textContent = `Trang ${currentPage} / ${totalPages}`;
                prevBtn.disabled = currentPage <= 1;
                nextBtn.disabled = currentPage >= totalPages;
            } else {
                pagination.style.display = 'none';
            }
        }

        function changeMealPage(direction) {
            const newPage = currentPage + direction;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                loadMeals();
            }
        }

        let searchTimeout;
        function handleMealSearch(event) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentSearch = event.target.value;
                currentPage = 1;
                loadMeals();
            }, 500);
        }

        function selectMealFromModal(mealId, mealName, imageUrl, calories, protein, carbs, fat, hasAllergen, allergenWarning) {
            document.getElementById(`meal-input-${currentDate}-${currentSlot}`).value = mealId;

            const selectedDiv = document.getElementById(`selected-meal-${currentDate}-${currentSlot}`);
            const selectedImage = document.getElementById(`selected-meal-image-${currentDate}-${currentSlot}`);
            const selectedName = document.getElementById(`selected-meal-name-${currentDate}-${currentSlot}`);
            const selectedInfo = document.getElementById(`selected-meal-info-${currentDate}-${currentSlot}`);
            const selectButton = document.querySelector(`button[data-date="${currentDate}"][data-slot="${currentSlot}"]`);

            selectedImage.src = imageUrl || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'60\' height=\'60\'%3E%3Crect fill=\'%23e5e7eb\' width=\'60\' height=\'60\'/%3E%3Ctext fill=\'%239ca3af\' font-family=\'Arial\' font-size=\'10\' x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dominant-baseline=\'middle\'%3ENo Image%3C/text%3E%3C/svg%3E';
            selectedName.textContent = mealName;
            selectedInfo.textContent = `${calories} cal • P:${protein} C:${carbs} F:${fat}`;
            selectedDiv.style.display = 'block';
            selectButton.style.display = 'none';

            const warningEl = document.getElementById(`warning-${currentDate}-${currentSlot}`);
            if (hasAllergen && allergenWarning) {
                if (warningEl) {
                    warningEl.querySelector('.warning-text').textContent = allergenWarning;
                    warningEl.style.display = 'block';
                }
            } else if (warningEl) {
                warningEl.style.display = 'none';
            }

            const modal = bootstrap.Modal.getInstance(document.getElementById('mealSelectionModal'));
            if (modal) {
                modal.hide();
            }
        }

        function clearMealSelection(date, slot) {
            document.getElementById(`meal-input-${date}-${slot}`).value = '';
            document.getElementById(`selected-meal-${date}-${slot}`).style.display = 'none';
            const selectButton = document.querySelector(`button[data-date="${date}"][data-slot="${slot}"]`);
            if (selectButton) {
                selectButton.style.display = 'inline-flex';
            }
            const warningEl = document.getElementById(`warning-${date}-${slot}`);
            if (warningEl) {
                warningEl.style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('mealSelectionForm');
            form.addEventListener('submit', function(e) {
                const submitBtn = form.querySelector('button[type="submit"]');
                const originalHtml = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Đang lưu...';
                setTimeout(() => {
                    if (submitBtn.disabled) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalHtml;
                    }
                }, 10000);
            });
            
            const modal = document.getElementById('mealSelectionModal');
            if (modal) {
                modal.addEventListener('hidden.bs.modal', function() {
                    currentDate = null;
                    currentSlot = null;
                    currentPage = 1;
                    currentSearch = '';
                });
            }
        });
    </script>
}
