@using System.Text.Json
@model MealPrep.Web.ViewModels.DashboardVm
@{
    ViewData["Title"] = "B·∫£ng ƒêi·ªÅu Khi·ªÉn";
}

<div class="d-flex align-items-end justify-content-between mb-3">
    <div>
        <h3 class="fw-bold mb-1">Ch√†o m·ª´ng tr·ªü l·∫°i üëã</h3>
        <div class="text-secondary">Qu·∫£n l√Ω m√≥n ƒÉn, ƒëƒÉng k√Ω v√† theo d√µi dinh d∆∞·ª°ng m·ªçi n∆°i.</div>
    </div>
    <div class="d-flex gap-2">
        <a class="btn btn-primary" asp-controller="Subscription" asp-action="Index">ƒêƒÉng K√Ω</a>
        <a class="btn btn-outline-secondary" asp-controller="NutritionLog" asp-action="Create">Th√™m Nh·∫≠t K√Ω</a>
    </div>
</div>

<div class="row g-3">
    <div class="col-md-4">
        <div class="app-card p-3">
            <div class="kpi-title">ƒêƒÉng K√Ω</div>
            <div class="kpi-value mt-1">@Model.SubscriptionStatus</div>
            <div class="mt-2"><span class="chip">L·ªëi s·ªëng nƒÉng ƒë·ªông</span></div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="app-card p-3">
            <div class="kpi-title">Giao H√†ng Ti·∫øp Theo</div>
            <div class="kpi-value mt-1">@Model.NextDeliveryText</div>
            <div class="mt-2"><a class="link-muted" asp-controller="Subscription" asp-action="Index">Qu·∫£n l√Ω ƒëƒÉng k√Ω ‚Üí</a></div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="app-card p-3">
            <div class="kpi-title">Calo H√¥m Nay</div>
            <div class="kpi-value mt-1">@Model.TodayCalories kcal</div>
            <div class="mt-2"><a class="link-muted" asp-controller="NutritionLog" asp-action="Index">Xem dinh d∆∞·ª°ng ‚Üí</a></div>
        </div>
    </div>
</div>

<div class="row g-3 mt-1">
    <div class="col-lg-8">
        <div class="app-card p-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="fw-semibold mb-0">M√≥n ƒÇn N·ªïi B·∫≠t</h5>
                <a class="link-muted" asp-controller="Meal" asp-action="Index">Xem t·∫•t c·∫£ ‚Üí</a>
            </div>

            <div class="row g-3">
                @foreach (var mealWithRating in Model.FeaturedMealsWithRatings)
                {
                    var m = mealWithRating.Meal;
                    var imageUrls = new List<string>();
                    try
                    {
                        if (!string.IsNullOrEmpty(m.Images))
                        {
                            imageUrls = JsonSerializer.Deserialize<List<string>>(m.Images) ?? new List<string>();
                        }
                    }
                    catch { }

                    var firstImage = imageUrls.FirstOrDefault() ?? "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='300'%3E%3Crect fill='%23e5e7eb' width='400' height='300'/%3E%3Ctext fill='%239ca3af' font-family='Arial' font-size='16' x='50%25' y='50%25' text-anchor='middle' dominant-baseline='middle'%3ENo Image%3C/text%3E%3C/svg%3E";

                    <div class="col-md-6 col-xl-4">
                        <div class="app-card p-2">
                            <div class="meal-thumb mb-2 position-relative" style="background-image: url('@firstImage'); background-size: cover; background-position: center; height: 150px; border-radius: 8px;">
                                @if (mealWithRating.AverageRating > 0)
                                {
                                    <div class="position-absolute top-0 end-0 m-2">
                                        <span class="badge bg-warning text-dark" style="font-size: 0.85rem;">
                                            <i class="bi bi-star-fill"></i> @mealWithRating.AverageRating.ToString("N1")
                                        </span>
                                    </div>
                                }
                            </div>
                            <div class="px-1 pb-1">
                                <div class="fw-semibold">@m.Name</div>
                                <div class="meal-meta">
                                    @m.Calories kcal ‚Ä¢ P @m.Protein ‚Ä¢ C @m.Carbs ‚Ä¢ F @m.Fat
                                    @if (mealWithRating.AverageRating > 0)
                                    {
                                        <span class="d-block mt-1">
                                            <i class="bi bi-star-fill text-warning"></i>
                                            <small class="text-muted">
                                                <strong>@mealWithRating.AverageRating.ToString("N1")</strong> / 5.0
                                                @if (mealWithRating.RatingCount > 0)
                                                {
                                                    <span class="text-muted">(@mealWithRating.RatingCount ƒë√°nh gi√°)</span>
                                                }
                                            </small>
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="d-block mt-1">
                                            <small class="text-muted">Ch∆∞a c√≥ ƒë√°nh gi√°</small>
                                        </span>
                                    }
                                </div>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <a class="btn btn-sm btn-outline-secondary" asp-controller="Meal" asp-action="Details" asp-route-id="@m.Id">Xem</a>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="app-card p-3 mb-3">
            <h5 class="fw-semibold">Thao T√°c Nhanh</h5>
            <div class="d-grid gap-2">
                <a class="btn btn-outline-secondary" asp-controller="Meal" asp-action="Index">Xem m√≥n ƒÉn</a>
                <a class="btn btn-outline-secondary" asp-controller="Subscription" asp-action="Index">T·∫°o ƒëƒÉng k√Ω</a>
                <a class="btn btn-outline-secondary" asp-controller="NutritionLog" asp-action="Create">Th√™m nh·∫≠t k√Ω</a>
            </div>
        </div>

        <div class="app-card p-3">
            <h5 class="fw-semibold mb-2">Calo 7 Ng√†y Qua</h5>
            <div class="small text-secondary mb-2">Xu h∆∞·ªõng tu·∫ßn n√†y (b·∫£ng).</div>

            <table class="table table-sm mb-0">
                <thead>
                    <tr><th>Ng√†y</th><th class="text-end">kcal</th></tr>
                </thead>
                <tbody>
                    @if (Model.WeekCalories.Count == 0)
                    {
                        <tr><td colspan="2" class="text-secondary">Ch∆∞a c√≥ nh·∫≠t k√Ω.</td></tr>
                    }
                    else
                    {
                        foreach (var d in Model.WeekCalories)
                        {
                            <tr>
                                <td>@d.Date.ToString("dd/MM")</td>
                                <td class="text-end">@d.Calories</td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="app-card p-3 mt-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="fw-semibold mb-0">ƒê∆°n H√†ng G·∫ßn ƒê√¢y</h5>
        <div class="d-flex align-items-center gap-2">
            <span class="text-secondary small">5 ƒë∆°n g·∫ßn nh·∫•t</span>
            @if (Model.RecentOrders.Count > 0)
            {
                <a asp-controller="UserSubscriptions" asp-action="Index" class="btn btn-sm btn-outline-primary">
                    Xem t·∫•t c·∫£ <i class="bi bi-arrow-right ms-1"></i>
                </a>
            }
        </div>
    </div>

    <table class="table mb-0">
        <thead>
            <tr>
                <th>Ng√†y</th>
                <th>Khung Gi·ªù</th>
                <th>Tr·∫°ng Th√°i</th>
                <th>M√≥n ƒÇn</th>
                <th>Thao T√°c</th>
            </tr>
        </thead>
        <tbody>
            @if (Model.RecentOrders.Count == 0)
            {
                <tr><td colspan="5" class="text-secondary text-center py-4">Ch∆∞a c√≥ ƒë∆°n h√†ng.</td></tr>
            }
            else
            {
                foreach (var o in Model.RecentOrders)
                {
                    <tr>
                        <td>@o.DeliveryDate.ToString("dd/MM/yyyy")</td>
                        <td>@(o.DeliverySlot?.Name ?? "N/A")</td>
                        <td>
                            @switch (o.Status.ToString())
                            {
                                case "Planned":
                                    <span class="badge bg-info">ƒê√£ L√™n L·ªãch</span>
                                    break;
                                case "Preparing":
                                    <span class="badge bg-warning">ƒêang Chu·∫©n B·ªã</span>
                                    break;
                                case "Delivering":
                                    <span class="badge bg-primary">ƒêang Giao</span>
                                    break;
                                case "Delivered":
                                    <span class="badge bg-success">ƒê√£ Giao</span>
                                    break;
                                case "Cancelled":
                                    <span class="badge bg-danger">ƒê√£ H·ªßy</span>
                                    break;
                                default:
                                    <span class="badge bg-secondary">@o.Status</span>
                                    break;
                            }
                        </td>
                        <td class="text-secondary">
                            @if (o.Items != null && o.Items.Any())
                            {
                                <span>@string.Join(", ", o.Items.Take(2).Select(i => $"{i.Meal?.Name ?? "N/A"} x{i.Quantity}"))</span>
                                @if (o.Items.Count > 2)
                                {
                                    <span class="text-muted">+@(o.Items.Count - 2) m√≥n kh√°c</span>
                                }
                            }
                            else
                            {
                                <span class="text-muted">Ch∆∞a c√≥ m√≥n</span>
                            }
                        </td>
                        <td>
                            @if (o.SubscriptionId > 0)
                            {
                                <a asp-controller="UserSubscriptions" asp-action="Details" asp-route-id="@o.SubscriptionId" 
                                   class="btn btn-sm btn-outline-primary" title="Xem chi ti·∫øt subscription">
                                    <i class="bi bi-eye"></i>
                                </a>
                            }
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
</div>