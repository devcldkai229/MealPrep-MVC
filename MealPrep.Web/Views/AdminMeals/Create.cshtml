@model MealPrep.DAL.Entities.Meal
@{
    ViewData["Title"] = "Thêm Món Ăn Mới";
    Layout = "_AdminLayout";
}

<style>
    /* Hiệu ứng nút ghi âm đang hoạt động */
    .btn-recording {
        animation: pulse-red 1.5s infinite;
        background-color: #dc3545 !important;
        color: white !important;
        border-color: #dc3545 !important;
    }

    @@keyframes pulse-red {
        0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
        100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
    }

    /* Hiệu ứng sóng âm */
    .voice-visualizer {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 20px;
        gap: 3px;
    }
    .voice-bar {
        width: 4px;
        background-color: #dc3545;
        border-radius: 2px;
        animation: sound-wave 0s infinite;
    }
    .recording .voice-bar { animation-duration: 0.8s; }
    .voice-bar:nth-child(1) { animation-delay: 0.2s; height: 10px; }
    .voice-bar:nth-child(2) { animation-delay: 0.4s; height: 15px; }
    .voice-bar:nth-child(3) { animation-delay: 0.0s; height: 20px; }
    .voice-bar:nth-child(4) { animation-delay: 0.3s; height: 12px; }
    .voice-bar:nth-child(5) { animation-delay: 0.5s; height: 10px; }

    @@keyframes sound-wave {
        0%, 100% { height: 10px; }
        50% { height: 25px; }
    }
</style>

<div>
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold mb-1">Thêm Món Ăn Mới</h2>
            <p class="text-muted mb-0">Tạo món ăn mới trong hệ thống</p>
        </div>
        <a asp-action="Index" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-2"></i>Quay Lại
        </a>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Card trợ lý AI ghi âm trực tiếp -->
            <div class="app-card p-4 mb-4 border-primary border-top border-3 shadow-sm">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="fw-bold text-primary mb-1">
                            <i class="bi bi-robot me-2"></i>Trợ Lý AI Bếp Trưởng
                        </h5>
                        <p class="text-muted small mb-0">
                            Bấm micro và nói (VD: <i>"Món ức gà sốt cam, 300g gà, 20ml sốt..."</i>). 
                            AI sẽ phân tích và tự điền form bên dưới.
                        </p>
                    </div>

                    <button type="button"
                            id="btnRecord"
                            class="btn btn-outline-danger rounded-circle d-flex align-items-center justify-content-center"
                            style="width: 50px; height: 50px; transition: all 0.3s;">
                        <i class="bi bi-mic-fill fs-5"></i>
                    </button>
                </div>

                <div id="recordingStatus" class="mt-3 text-center d-none">
                    <div class="voice-visualizer recording">
                        <div class="voice-bar"></div>
                        <div class="voice-bar"></div>
                        <div class="voice-bar"></div>
                        <div class="voice-bar"></div>
                        <div class="voice-bar"></div>
                    </div>
                    <span class="text-danger small fw-bold mt-1 d-block">
                        Đang nghe... Bấm nút đỏ để hoàn tất
                    </span>
                </div>

                <div id="processingStatus" class="mt-3 text-center d-none">
                    <div class="spinner-border text-primary spinner-border-sm" role="status"></div>
                    <span class="text-primary small ms-2 fw-bold">
                        AI đang phân tích &amp; tính toán dinh dưỡng...
                    </span>
                </div>
            </div>

            <!-- Form tạo món ăn -->
            <div class="app-card p-4">
                <form asp-action="Create" method="post" enctype="multipart/form-data">
                    @Html.AntiForgeryToken()
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                    <div class="mb-3">
                        <label asp-for="Name" class="form-label fw-bold">Tên Món Ăn <span class="text-danger">*</span></label>
                        <input asp-for="Name" class="form-control" />
                        <span asp-validation-for="Name" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Description" class="form-label fw-bold">Mô Tả</label>
                        <textarea asp-for="Description" class="form-control" rows="4"></textarea>
                        <span asp-validation-for="Description" class="text-danger"></span>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label asp-for="Calories" class="form-label fw-bold">Calories <span class="text-danger">*</span></label>
                            <input asp-for="Calories" type="number" class="form-control" />
                            <span asp-validation-for="Calories" class="text-danger"></span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label asp-for="BasePrice" class="form-label fw-bold">Giá Cơ Bản <span class="text-danger">*</span></label>
                            <input asp-for="BasePrice" type="number" step="1000" class="form-control" />
                            <span asp-validation-for="BasePrice" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label asp-for="Protein" class="form-label fw-bold">Protein (g) <span class="text-danger">*</span></label>
                            <input asp-for="Protein" type="number" step="0.1" class="form-control" />
                            <span asp-validation-for="Protein" class="text-danger"></span>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label asp-for="Carbs" class="form-label fw-bold">Carbs (g) <span class="text-danger">*</span></label>
                            <input asp-for="Carbs" type="number" step="0.1" class="form-control" />
                            <span asp-validation-for="Carbs" class="text-danger"></span>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label asp-for="Fat" class="form-label fw-bold">Fat (g) <span class="text-danger">*</span></label>
                            <input asp-for="Fat" type="number" step="0.1" class="form-control" />
                            <span asp-validation-for="Fat" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Ingredients" class="form-label fw-bold">Thành Phần (JSON Array)</label>
                        <textarea asp-for="Ingredients" class="form-control" rows="3" placeholder='["Thành phần 1", "Thành phần 2", ...]'></textarea>
                        <small class="text-muted">Nhập dạng JSON array, ví dụ: ["Ức gà", "Rau xà lách", "Cà chua"]</small>
                        <span asp-validation-for="Ingredients" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Hình Ảnh</label>
                        <input type="file" name="imageFiles" class="form-control" multiple accept="image/*" />
                        <small class="text-muted">Chọn một hoặc nhiều hình ảnh để upload lên S3. Hệ thống sẽ tự động lưu key trong database.</small>
                        <div id="imagePreview" class="mt-3 d-flex flex-wrap gap-2"></div>
                    </div>

                    <div class="mb-3 form-check">
                        <input asp-for="IsActive" type="checkbox" class="form-check-input" checked />
                        <label asp-for="IsActive" class="form-check-label">Kích hoạt món ăn</label>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-2"></i>Tạo Món Ăn
                        </button>
                        <a asp-action="Index" class="btn btn-outline-secondary">Hủy</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let mediaRecorder;
            let audioChunks = [];
            let isRecording = false;

            const btnRecord = document.getElementById('btnRecord');
            const statusRec = document.getElementById('recordingStatus');
            const statusProc = document.getElementById('processingStatus');

            // Các input form cần điền
            const inpName = document.getElementById('Name');
            const inpDesc = document.getElementById('Description');
            const inpCal = document.getElementById('Calories');
            const inpPro = document.getElementById('Protein');
            const inpCarb = document.getElementById('Carbs');
            const inpFat = document.getElementById('Fat');
            const inpPrice = document.getElementById('BasePrice');
            const inpIng = document.getElementById('Ingredients');

            btnRecord.addEventListener('click', async () => {
                if (!isRecording) {
                    await startRecording();
                } else {
                    await stopRecordingAndSend();
                }
            });

            async function startRecording() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.start();
                    isRecording = true;

                    // UI Update
                    btnRecord.classList.add('btn-recording');
                    btnRecord.innerHTML = '<i class="bi bi-stop-fill fs-4"></i>'; // Icon Stop
                    statusRec.classList.remove('d-none');
                    statusProc.classList.add('d-none');

                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };

                } catch (err) {
                    alert("Không thể truy cập Micro: " + err.message);
                }
            }

            async function stopRecordingAndSend() {
                // UI Update: Chuyển sang trạng thái xử lý
                isRecording = false;
                mediaRecorder.stop();
                btnRecord.classList.remove('btn-recording');
                btnRecord.innerHTML = '<i class="bi bi-mic-fill fs-5"></i>';
                statusRec.classList.add('d-none');
                
                // Đợi một chút để sự kiện onstop của mediaRecorder hoàn tất
                mediaRecorder.onstop = async () => {
                    statusProc.classList.remove('d-none'); // Hiện loading

                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    
                    // Gọi sang Python Service
                    await sendAudioToPython(audioBlob);
                };
            }

            async function sendAudioToPython(blob) {
                const formData = new FormData();
                // Lưu ý: Đuôi file .webm để tương thích với Whisper
                formData.append("file", blob, "voice_input.webm");

                try {
                    // Gọi trực tiếp Python service generate_meal_ai
                    const response = await fetch("http://127.0.0.1:8001/api/analyze-voice", {
                        method: "POST",
                        body: formData
                    });

                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.detail || "Lỗi Service AI");
                    }

                    const data = await response.json();
                    console.log("AI Response:", data);

                    // --- MAPPING DỮ LIỆU VÀO FORM (phù hợp input/output AI) ---
                    // 1. Text Fields
                    inpName.value = data.dish_name || "";
                    inpDesc.value = data.description || "";

                    // 2. Nutrition Numbers từ total_nutrition
                    if (data.total_nutrition) {
                        inpCal.value = data.total_nutrition.calories ?? 0;
                        inpPro.value = data.total_nutrition.protein_g ?? 0;
                        inpCarb.value = data.total_nutrition.carbs_g ?? 0;
                        inpFat.value = data.total_nutrition.fat_g ?? 0;
                    }

                    // 3. Giá gợi ý
                    if (typeof data.base_price_estimate === 'number') {
                        inpPrice.value = data.base_price_estimate;
                    }

                    // 4. Ingredients: chuyển thành JSON array of string cho field Ingredients
                    if (Array.isArray(data.ingredients)) {
                        const simpleIngList = data.ingredients.map(i => {
                            const name = i.name ?? '';
                            const amount = i.amount_value ?? 0;
                            const unit = i.unit ?? '';
                            const kcal = i.calories ?? 0;
                            return `${amount}${unit} ${name} (${kcal} kcal)`;
                        });
                        inpIng.value = JSON.stringify(simpleIngList);
                    }

                    // 5. Hiển thị thông báo Toast/Alert
                    statusProc.classList.add('d-none');
                    // Flash effect cho form để user biết dữ liệu đã điền
                    document.querySelector('form').classList.add('bg-light');
                    setTimeout(() => document.querySelector('form').classList.remove('bg-light'), 500);
                    
                } catch (error) {
                    console.error(error);
                    alert("Lỗi phân tích AI: " + error.message + "\n(Đảm bảo Python Service đang chạy ở Port 8001)");
                    statusProc.classList.add('d-none');
                }
            }
        });
        
        // Code Preview ảnh giữ nguyên như cũ...
        document.querySelector('input[name="imageFiles"]').addEventListener('change', function(e) {
             // ... giữ nguyên code preview ảnh của bạn ...
        });
    </script>
}