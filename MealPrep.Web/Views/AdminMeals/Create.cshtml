@model MealPrep.DAL.Entities.Meal
@{
    ViewData["Title"] = "Thêm Món Ăn Mới";
    Layout = "_AdminLayout";
}

<div>
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold mb-1">Thêm Món Ăn Mới</h2>
            <p class="text-muted mb-0">Tạo món ăn mới trong hệ thống</p>
        </div>
        <a asp-action="Index" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-2"></i>Quay Lại
        </a>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="app-card p-4 mb-4">
                <h5 class="fw-bold mb-3">Nhập nhanh bằng giọng nói (AI)</h5>
                <p class="text-muted small mb-3">
                    Khi bếp đang bận tay, bạn có thể bấm ghi âm, mô tả tên món, nguyên liệu, định lượng, cách nấu...
                    Hệ thống sẽ tự động phân tích và điền sẵn form bên dưới để bạn kiểm tra lại.
                </p>
                <div class="row g-3 align-items-center">
                    <div class="col-md-6">
                        <input type="file" id="voiceFile" name="voiceFile" class="form-control" accept="audio/*" />
                        <small class="text-muted">Hỗ trợ: wav, mp3, m4a, flac, webm</small>
                    </div>
                    <div class="col-md-3 d-grid">
                        <button type="button" id="btnAnalyzeVoice" class="btn btn-outline-primary">
                            <i class="bi bi-mic me-2"></i>Phân tích bằng AI
                        </button>
                    </div>
                    <div class="col-md-3">
                        <div id="voiceStatus" class="small text-muted"></div>
                    </div>
                </div>
            </div>

            <div class="app-card p-4">
                <form asp-action="Create" method="post" enctype="multipart/form-data">
                    @Html.AntiForgeryToken()
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                    <div class="mb-3">
                        <label asp-for="Name" class="form-label fw-bold">Tên Món Ăn <span class="text-danger">*</span></label>
                        <input asp-for="Name" class="form-control" />
                        <span asp-validation-for="Name" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Description" class="form-label fw-bold">Mô Tả</label>
                        <textarea asp-for="Description" class="form-control" rows="4"></textarea>
                        <span asp-validation-for="Description" class="text-danger"></span>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label asp-for="Calories" class="form-label fw-bold">Calories <span class="text-danger">*</span></label>
                            <input asp-for="Calories" type="number" class="form-control" />
                            <span asp-validation-for="Calories" class="text-danger"></span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label asp-for="BasePrice" class="form-label fw-bold">Giá Cơ Bản <span class="text-danger">*</span></label>
                            <input asp-for="BasePrice" type="number" step="1000" class="form-control" />
                            <span asp-validation-for="BasePrice" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label asp-for="Protein" class="form-label fw-bold">Protein (g) <span class="text-danger">*</span></label>
                            <input asp-for="Protein" type="number" step="0.1" class="form-control" />
                            <span asp-validation-for="Protein" class="text-danger"></span>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label asp-for="Carbs" class="form-label fw-bold">Carbs (g) <span class="text-danger">*</span></label>
                            <input asp-for="Carbs" type="number" step="0.1" class="form-control" />
                            <span asp-validation-for="Carbs" class="text-danger"></span>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label asp-for="Fat" class="form-label fw-bold">Fat (g) <span class="text-danger">*</span></label>
                            <input asp-for="Fat" type="number" step="0.1" class="form-control" />
                            <span asp-validation-for="Fat" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Ingredients" class="form-label fw-bold">Thành Phần (JSON Array)</label>
                        <textarea asp-for="Ingredients" class="form-control" rows="3" placeholder='["Thành phần 1", "Thành phần 2", ...]'></textarea>
                        <small class="text-muted">Nhập dạng JSON array, ví dụ: ["Ức gà", "Rau xà lách", "Cà chua"]</small>
                        <span asp-validation-for="Ingredients" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Hình Ảnh</label>
                        <input type="file" name="imageFiles" class="form-control" multiple accept="image/*" />
                        <small class="text-muted">Chọn một hoặc nhiều hình ảnh để upload lên S3. Hỗ trợ: JPG, PNG, GIF, WebP</small>
                        <div id="imagePreview" class="mt-3 d-flex flex-wrap gap-2"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label asp-for="Images" class="form-label fw-bold">Hoặc Nhập URL Hình Ảnh (JSON Array) - Tùy chọn</label>
                        <textarea asp-for="Images" class="form-control" rows="2" placeholder='["URL 1", "URL 2", ...]'></textarea>
                        <small class="text-muted">Nếu không upload file, bạn có thể nhập URL hình ảnh dạng JSON array</small>
                        <span asp-validation-for="Images" class="text-danger"></span>
                    </div>

                    <div class="mb-3 form-check">
                        <input asp-for="IsActive" type="checkbox" class="form-check-input" checked />
                        <label asp-for="IsActive" class="form-check-label">Kích hoạt món ăn</label>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-2"></i>Tạo Món Ăn
                        </button>
                        <a asp-action="Index" class="btn btn-outline-secondary">Hủy</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        // Preview images before upload
        document.querySelector('input[name="imageFiles"]').addEventListener('change', function(e) {
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = '';
            
            Array.from(e.target.files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.style.width = '150px';
                        img.style.height = '150px';
                        img.style.objectFit = 'cover';
                        img.style.borderRadius = '8px';
                        img.style.border = '1px solid #dee2e6';
                        preview.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                }
            });
        });

        // Voice-to-meal AI: gọi AdminMeals/AnalyzeMealVoice và fill form
        (function () {
            const btnAnalyze = document.getElementById('btnAnalyzeVoice');
            const fileInput = document.getElementById('voiceFile');
            const statusEl = document.getElementById('voiceStatus');

            if (!btnAnalyze || !fileInput) return;

            btnAnalyze.addEventListener('click', async function () {
                if (!fileInput.files || fileInput.files.length === 0) {
                    statusEl.textContent = 'Vui lòng chọn file audio trước.';
                    statusEl.classList.remove('text-success');
                    statusEl.classList.add('text-danger');
                    return;
                }

                const form = document.querySelector('form[asp-action="Create"]');
                const antiForgery = form.querySelector('input[name="__RequestVerificationToken"]');

                const formData = new FormData();
                formData.append('audioFile', fileInput.files[0]);
                if (antiForgery) {
                    formData.append('__RequestVerificationToken', antiForgery.value);
                }

                btnAnalyze.disabled = true;
                statusEl.textContent = 'Đang phân tích audio bằng AI...';
                statusEl.classList.remove('text-danger', 'text-success');

                try {
                    const response = await fetch('@Url.Action("AnalyzeMealVoice", "AdminMeals")', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    if (!response.ok || !result.success) {
                        throw new Error(result.message || 'AI không phân tích được audio.');
                    }

                    // Fill form fields
                    document.getElementById('Name').value = result.dishName || '';
                    document.getElementById('Description').value = result.description || '';
                    document.getElementById('Ingredients').value = result.ingredientsJson || '';
                    document.getElementById('Calories').value = result.calories || 0;
                    document.getElementById('Protein').value = result.protein || 0;
                    document.getElementById('Carbs').value = result.carbs || 0;
                    document.getElementById('Fat').value = result.fat || 0;
                    document.getElementById('BasePrice').value = result.basePrice || 0;

                    statusEl.textContent = 'Đã phân tích xong. Vui lòng kiểm tra lại thông tin trước khi lưu.';
                    statusEl.classList.remove('text-danger');
                    statusEl.classList.add('text-success');
                } catch (err) {
                    console.error(err);
                    statusEl.textContent = err.message || 'Có lỗi xảy ra khi gọi AI.';
                    statusEl.classList.remove('text-success');
                    statusEl.classList.add('text-danger');
                } finally {
                    btnAnalyze.disabled = false;
                }
            });
        })();
    </script>
}
